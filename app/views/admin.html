<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Getouch Admin</title>
  <link rel="stylesheet" href="/css/styles.css?v={{VERSION}}">
  <script defer src="https://analytics.getouch.co/getscript" data-website-id="c1cbd077-9d1f-4fed-9985-8e9abf55fccd"></script>
</head>
<body>
  <div class="admin-layout">
    <!-- ‚îÄ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <nav class="admin-nav">
      <div class="admin-nav__logo">ge<span>touch</span> admin</div>
      <a href="/admin/" class="admin-nav__link active">Dashboard</a>
      <a href="/admin/ops" class="admin-nav__link">Ops Dashboard</a>
      <a href="/" class="admin-nav__link">‚Üê Home</a>
    </nav>

    <!-- ‚îÄ‚îÄ‚îÄ Content ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="admin-content admin-content--wide">
      <h1 class="admin-content__title">Dashboard</h1>
      <p class="admin-content__subtitle">Protected by Cloudflare Access ¬∑ v{{VERSION}}</p>

      <!-- ‚îÄ‚îÄ Tab Navigation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div class="admin-tabs" role="tablist" aria-label="Admin sections">
        <button class="admin-tab active" role="tab" aria-selected="true" aria-controls="panel-overview" data-tab="overview">
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-4 0a1 1 0 01-1-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 01-1 1"/></svg>
          Overview
        </button>
        <button class="admin-tab" role="tab" aria-selected="false" aria-controls="panel-ai" data-tab="ai">
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
          AI Config
        </button>
        <button class="admin-tab" role="tab" aria-selected="false" aria-controls="panel-services" data-tab="services">
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 6h16M4 10h16M4 14h16M4 18h16"/></svg>
          Services
        </button>
        <button class="admin-tab" role="tab" aria-selected="false" aria-controls="panel-infra" data-tab="infra">
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.573-1.066z"/><circle cx="12" cy="12" r="3"/></svg>
          Infrastructure
        </button>
        <button class="admin-tab" role="tab" aria-selected="false" aria-controls="panel-users" data-tab="users">
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>
          Users
        </button>
        <button class="admin-tab" role="tab" aria-selected="false" aria-controls="panel-reporting" data-tab="reporting">
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
          Reporting
        </button>
      </div>

      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           Tab 1: Overview
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <div class="admin-panel active" id="panel-overview" role="tabpanel">

        <!-- Service Health -->
        <div class="ops-section">
          <h2 class="ops-section__title">Service Health</h2>
          <div class="health-grid" id="health-grid">

            <div class="health-item" id="health-landing">
              <div class="health-item__dot health-item__dot--checking"></div>
              <div class="health-item__info">
                <div class="health-item__name">Landing</div>
                <div class="health-item__url">checking‚Ä¶</div>
              </div>
              <div class="health-item__latency" id="lat-landing">‚Ä¶</div>
            </div>

            <div class="health-item" id="health-bot">
              <div class="health-item__dot health-item__dot--checking"></div>
              <div class="health-item__info">
                <div class="health-item__name">Bot / AI</div>
                <div class="health-item__url">checking‚Ä¶</div>
              </div>
              <div class="health-item__latency" id="lat-bot">‚Ä¶</div>
            </div>

            <div class="health-item" id="health-wa">
              <div class="health-item__dot health-item__dot--checking"></div>
              <div class="health-item__info">
                <div class="health-item__name">WhatsApp</div>
                <div class="health-item__url">checking‚Ä¶</div>
              </div>
              <div class="health-item__latency" id="lat-wa">‚Ä¶</div>
            </div>

            <div class="health-item" id="health-api">
              <div class="health-item__dot health-item__dot--checking"></div>
              <div class="health-item__info">
                <div class="health-item__name">API</div>
                <div class="health-item__url">checking‚Ä¶</div>
              </div>
              <div class="health-item__latency" id="lat-api">‚Ä¶</div>
            </div>

            <div class="health-item" id="health-ollama">
              <div class="health-item__dot health-item__dot--checking"></div>
              <div class="health-item__info">
                <div class="health-item__name">Ollama</div>
                <div class="health-item__url">checking‚Ä¶</div>
              </div>
              <div class="health-item__latency" id="lat-ollama">‚Ä¶</div>
            </div>

            <div class="health-item" id="health-comfyui">
              <div class="health-item__dot health-item__dot--checking"></div>
              <div class="health-item__info">
                <div class="health-item__name">ComfyUI</div>
                <div class="health-item__url">checking‚Ä¶</div>
              </div>
              <div class="health-item__latency" id="lat-comfyui">‚Ä¶</div>
            </div>

          </div>

          <!-- Health Details Box -->
          <div class="info-box" id="health-info" style="margin-top:12px; display:none;">
            <div class="info-box__title">‚ö†Ô∏è Offline Services Detected</div>
            <p class="info-box__text" id="health-info-text"></p>
          </div>
        </div>

        <!-- Recent Activity / Event Log -->
        <div class="ops-section">
          <h2 class="ops-section__title">Recent Activity</h2>
          <div class="activity-log" id="activity-log">
            <div class="activity-item">
              <div class="activity-item__time" id="activity-time">‚Äî</div>
              <div class="activity-item__body">
                <div class="activity-item__title">Health check performed</div>
                <div class="activity-item__desc" id="activity-summary">Checking services‚Ä¶</div>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           Tab 2: AI Config
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <div class="admin-panel" id="panel-ai" role="tabpanel">

        <div class="ops-section">
          <h2 class="ops-section__title">AI Settings</h2>
          <div class="ai-settings" id="ai-settings">

            <div class="ai-setting">
              <label class="ai-setting__label">Default Text Model</label>
              <p class="ai-setting__hint">Used when users don't specify a model on the landing page.</p>
              <select class="ai-setting__select" id="setting-default-model">
                <option value="">Loading models‚Ä¶</option>
              </select>
            </div>

            <div class="ai-setting">
              <label class="ai-setting__label">Default Vision Model</label>
              <p class="ai-setting__hint">Used when users attach an image in chat (requires vision-capable model).</p>
              <select class="ai-setting__select" id="setting-vision-model">
                <option value="">Loading models‚Ä¶</option>
              </select>
            </div>

            <div class="ai-setting">
              <label class="ai-setting__label">Enable Getouch Image</label>
              <p class="ai-setting__hint">Toggle image generation via ComfyUI for public users.</p>
              <label class="ai-toggle">
                <input type="checkbox" id="setting-enable-image" checked>
                <span class="ai-toggle__slider"></span>
                <span class="ai-toggle__text" id="toggle-text">Enabled</span>
              </label>
            </div>

            <div class="ai-setting">
              <label class="ai-setting__label">Default Image Engine</label>
              <p class="ai-setting__hint">Select which ComfyUI pipeline to use for image generation.</p>
              <select class="ai-setting__select" id="setting-image-engine">
                <option value="sdxl">SDXL (Stable Diffusion XL)</option>
                <option value="flux">FLUX</option>
              </select>
            </div>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
              <div class="ai-setting">
                <label class="ai-setting__label">PROD ‚Äî Images/Day</label>
                <p class="ai-setting__hint">Daily image quota for production API keys.</p>
                <input type="number" class="ai-setting__input" id="setting-max-images-prod" value="10" min="0" max="1000">
              </div>
              <div class="ai-setting">
                <label class="ai-setting__label">DEV ‚Äî Images/Day</label>
                <p class="ai-setting__hint">Daily image quota for development API keys.</p>
                <input type="number" class="ai-setting__input" id="setting-max-images-dev" value="50" min="0" max="1000">
              </div>
            </div>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:12px;">
              <div class="ai-setting">
                <label class="ai-setting__label">PROD ‚Äî Chat RPM</label>
                <p class="ai-setting__hint">Chat requests per minute (production).</p>
                <input type="number" class="ai-setting__input" id="setting-rate-chat-prod" value="15" min="1" max="1000">
              </div>
              <div class="ai-setting">
                <label class="ai-setting__label">DEV ‚Äî Chat RPM</label>
                <p class="ai-setting__hint">Chat requests per minute (development).</p>
                <input type="number" class="ai-setting__input" id="setting-rate-chat-dev" value="60" min="1" max="1000">
              </div>
            </div>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:12px;">
              <div class="ai-setting">
                <label class="ai-setting__label">PROD ‚Äî Image RPM</label>
                <p class="ai-setting__hint">Image gen requests per minute (production).</p>
                <input type="number" class="ai-setting__input" id="setting-rate-image-prod" value="5" min="1" max="1000">
              </div>
              <div class="ai-setting">
                <label class="ai-setting__label">DEV ‚Äî Image RPM</label>
                <p class="ai-setting__hint">Image gen requests per minute (development).</p>
                <input type="number" class="ai-setting__input" id="setting-rate-image-dev" value="20" min="1" max="1000">
              </div>
            </div>

            <!-- ‚îÄ‚îÄ Typing Effect Section ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
              <h3 style="font-size: .9rem; font-weight: 700; margin-bottom: 12px; color: var(--text);">‚å®Ô∏è AI Typing Effect</h3>
              <p class="ai-setting__hint" style="margin-bottom: 14px;">Controls how the AI response appears on the landing page chat. When enabled, text renders gradually with a typewriter animation instead of appearing instantly.</p>

              <div class="ai-setting">
                <label class="ai-setting__label">Enable Typewriter</label>
                <p class="ai-setting__hint">Toggle the typing animation for AI chat responses.</p>
                <label class="ai-toggle">
                  <input type="checkbox" id="setting-typing-enabled" checked>
                  <span class="ai-toggle__slider"></span>
                  <span class="ai-toggle__text" id="typing-toggle-text">Enabled</span>
                </label>
              </div>

              <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;" id="typing-detail-settings">
                <div class="ai-setting">
                  <label class="ai-setting__label">Chunk Mode</label>
                  <p class="ai-setting__hint">Render response word-by-word or character-by-character.</p>
                  <select class="ai-setting__select" id="setting-typing-mode">
                    <option value="word">Word</option>
                    <option value="char">Character</option>
                  </select>
                </div>
                <div class="ai-setting">
                  <label class="ai-setting__label">Speed (ms)</label>
                  <p class="ai-setting__hint">Delay per chunk (5‚Äì200). Lower = faster typing.</p>
                  <input type="number" class="ai-setting__input" id="setting-typing-speed" value="35" min="5" max="200" step="5">
                </div>
              </div>

              <div class="ai-setting" style="margin-top: 12px;">
                <label class="ai-setting__label">Adaptive Catch-Up</label>
                <p class="ai-setting__hint">Speed up rendering when the token buffer grows large (prevents lag).</p>
                <label class="ai-toggle">
                  <input type="checkbox" id="setting-typing-adaptive" checked>
                  <span class="ai-toggle__slider"></span>
                  <span class="ai-toggle__text" id="typing-adaptive-text">Enabled</span>
                </label>
              </div>
            </div>

            <!-- ‚îÄ‚îÄ Web Research Section ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
              <h3 style="font-size: .9rem; font-weight: 700; margin-bottom: 12px; color: var(--text);">üß† Personality & Routing</h3>
              <p class="ai-setting__hint" style="margin-bottom: 14px;">Controls the AI's smart routing, dialect mirroring, and personality behavior. When enabled, messages are automatically classified (smalltalk, task, question, etc.) and the AI adapts its tone and response style accordingly.</p>

              <div class="ai-setting">
                <label class="ai-setting__label">Enable Smart Personality</label>
                <p class="ai-setting__hint">Route-aware system prompts with dialect mirroring and tone matching.</p>
                <label class="ai-toggle">
                  <input type="checkbox" id="setting-personality-enabled" checked>
                  <span class="ai-toggle__slider"></span>
                  <span class="ai-toggle__text" id="personality-toggle-text">Enabled</span>
                </label>
              </div>

              <div class="ai-setting">
                <label class="ai-setting__label">Dialect Mirroring</label>
                <p class="ai-setting__hint">Mirror Northern Malay (Utara) dialect when detected. The AI will reply using casual Kedah‚ÄìPenang expressions.</p>
                <label class="ai-toggle">
                  <input type="checkbox" id="setting-dialect-mirroring" checked>
                  <span class="ai-toggle__slider"></span>
                  <span class="ai-toggle__text" id="dialect-toggle-text">Enabled</span>
                </label>
              </div>

              <div class="ai-setting">
                <label class="ai-setting__label">Smalltalk Stabilizer</label>
                <p class="ai-setting__hint">Prevents overcompensation of dialect tokens in casual greetings. The AI mirrors max 1‚Äì2 dialect words per reply.</p>
                <label class="ai-toggle">
                  <input type="checkbox" id="setting-stabilizer-enabled" checked>
                  <span class="ai-toggle__slider"></span>
                  <span class="ai-toggle__text" id="stabilizer-toggle-text">Enabled</span>
                </label>
              </div>

              <div class="ai-setting">
                <label class="ai-setting__label">Dialect Mirroring Level</label>
                <p class="ai-setting__hint">How much dialect the AI uses: off = standard BM only, light = 1‚Äì2 words, medium = natural mix.</p>
                <select class="ai-setting__select" id="setting-dialect-level">
                  <option value="off">Off ‚Äî Standard BM Only</option>
                  <option value="light" selected>Light ‚Äî 1‚Äì2 dialect words</option>
                  <option value="medium">Medium ‚Äî Natural mix</option>
                </select>
              </div>

              <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;">
                <div class="ai-setting">
                  <label class="ai-setting__label">Smalltalk Tokens</label>
                  <p class="ai-setting__hint">Max tokens for casual greetings.</p>
                  <input type="number" class="ai-setting__input" id="setting-smalltalk-tokens" value="256" min="64" max="1024" step="64">
                </div>
                <div class="ai-setting">
                  <label class="ai-setting__label">General Tokens</label>
                  <p class="ai-setting__hint">Max tokens for general chat.</p>
                  <input type="number" class="ai-setting__input" id="setting-general-tokens" value="1024" min="256" max="4096" step="256">
                </div>
                <div class="ai-setting">
                  <label class="ai-setting__label">Task Tokens</label>
                  <p class="ai-setting__hint">Max tokens for structured tasks.</p>
                  <input type="number" class="ai-setting__input" id="setting-task-tokens" value="2048" min="512" max="8192" step="256">
                </div>
              </div>
            </div>

            <!-- ‚îÄ‚îÄ Web Research Section ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
              <h3 style="font-size: .9rem; font-weight: 700; margin-bottom: 12px; color: var(--text);">üö¶ Guest Limits</h3>
              <p class="ai-setting__hint" style="margin-bottom: 14px;">Control usage limits for unauthenticated visitors. Set to 0 to disable the limit.</p>

              <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;">
                <div class="ai-setting">
                  <label class="ai-setting__label">Chats / Day</label>
                  <p class="ai-setting__hint">Max daily chat messages for guests.</p>
                  <input type="number" class="ai-setting__input" id="setting-guest-chat-day" value="50" min="0" max="500">
                </div>
                <div class="ai-setting">
                  <label class="ai-setting__label">Docs / Day</label>
                  <p class="ai-setting__hint">Max document uploads per day for guests.</p>
                  <input type="number" class="ai-setting__input" id="setting-guest-doc-day" value="5" min="0" max="100">
                </div>
                <div class="ai-setting">
                  <label class="ai-setting__label">Images / Day</label>
                  <p class="ai-setting__hint">Max image generations per day for guests.</p>
                  <input type="number" class="ai-setting__input" id="setting-guest-image-day" value="3" min="0" max="100">
                </div>
              </div>

              <div class="ai-setting" style="margin-top: 12px;">
                <label class="ai-setting__label">Suggest Register After N Chats</label>
                <p class="ai-setting__hint">Show registration prompt after this many chats. Set 0 to disable.</p>
                <input type="number" class="ai-setting__input" id="setting-guest-register-n" value="5" min="0" max="100">
              </div>
            </div>

            <!-- ‚îÄ‚îÄ Document Limits Section ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
              <h3 style="font-size: .9rem; font-weight: 700; margin-bottom: 12px; color: var(--text);">üìÑ Document Limits</h3>
              <p class="ai-setting__hint" style="margin-bottom: 14px;">File upload and processing limits for document analysis.</p>

              <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;">
                <div class="ai-setting">
                  <label class="ai-setting__label">Max File Size (MB)</label>
                  <p class="ai-setting__hint">Maximum upload size in megabytes.</p>
                  <input type="number" class="ai-setting__input" id="setting-max-file-mb" value="20" min="1" max="100">
                </div>
                <div class="ai-setting">
                  <label class="ai-setting__label">PDF Pages (Guest)</label>
                  <p class="ai-setting__hint">Max PDF pages for guest users.</p>
                  <input type="number" class="ai-setting__input" id="setting-pdf-pages-guest" value="5" min="1" max="50">
                </div>
                <div class="ai-setting">
                  <label class="ai-setting__label">PDF Pages (Registered)</label>
                  <p class="ai-setting__hint">Max PDF pages for registered users.</p>
                  <input type="number" class="ai-setting__input" id="setting-pdf-pages-registered" value="15" min="1" max="100">
                </div>
              </div>
            </div>

            <!-- ‚îÄ‚îÄ Web Research Section ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
              <h3 style="font-size: .9rem; font-weight: 700; margin-bottom: 12px; color: var(--text);">üåê Web Research</h3>
              <p class="ai-setting__hint" style="margin-bottom: 14px;">Allow the AI to search the web and fetch pages to answer time-sensitive questions with citations. Auto-detects when browsing is needed based on keywords.</p>

              <div class="ai-setting">
                <label class="ai-setting__label">Enable Web Research</label>
                <p class="ai-setting__hint">When enabled, the AI will automatically search the web for real-time information.</p>
                <label class="ai-toggle">
                  <input type="checkbox" id="setting-web-enabled">
                  <span class="ai-toggle__slider"></span>
                  <span class="ai-toggle__text" id="web-toggle-text">Disabled</span>
                </label>
              </div>

              <div id="web-research-details">
                <div class="ai-setting">
                  <label class="ai-setting__label">Search Provider</label>
                  <p class="ai-setting__hint">Which search engine to use for queries.</p>
                  <select class="ai-setting__select" id="setting-web-provider">
                    <option value="searxng">SearXNG (self-hosted)</option>
                    <option value="tavily">Tavily API</option>
                    <option value="serpapi">SerpAPI (Google)</option>
                  </select>
                </div>

                <div class="ai-setting" id="web-searxng-url-setting">
                  <label class="ai-setting__label">SearXNG URL</label>
                  <p class="ai-setting__hint">Internal URL of your SearXNG instance.</p>
                  <input type="text" class="ai-setting__input" id="setting-web-searxng-url" value="http://searxng:8080" placeholder="http://searxng:8080">
                </div>

                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                  <div class="ai-setting">
                    <label class="ai-setting__label">Max Sources</label>
                    <p class="ai-setting__hint">Maximum sources included in AI context (1‚Äì10).</p>
                    <input type="number" class="ai-setting__input" id="setting-web-max-sources" value="4" min="1" max="10">
                  </div>
                  <div class="ai-setting">
                    <label class="ai-setting__label">Max Fetch / Request</label>
                    <p class="ai-setting__hint">Maximum pages to fetch per query (1‚Äì10).</p>
                    <input type="number" class="ai-setting__input" id="setting-web-max-fetch" value="4" min="1" max="10">
                  </div>
                </div>

                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:12px;">
                  <div class="ai-setting">
                    <label class="ai-setting__label">Cache TTL (min)</label>
                    <p class="ai-setting__hint">How long cached results remain valid.</p>
                    <input type="number" class="ai-setting__input" id="setting-web-cache-ttl" value="30" min="1" max="999">
                  </div>
                  <div class="ai-setting">
                    <label class="ai-setting__label">Timeout / Page (sec)</label>
                    <p class="ai-setting__hint">Max time to fetch each page.</p>
                    <input type="number" class="ai-setting__input" id="setting-web-timeout" value="8" min="1" max="30">
                  </div>
                </div>

                <div class="ai-setting" style="margin-top:12px;">
                  <label class="ai-setting__label">Allowed Domains</label>
                  <p class="ai-setting__hint">Comma-separated allowlist. Leave empty to allow all.</p>
                  <input type="text" class="ai-setting__input" id="setting-web-allowed" value="" placeholder="example.com, trusted.org">
                </div>

                <div class="ai-setting" style="margin-top:12px;">
                  <label class="ai-setting__label">Blocked Domains</label>
                  <p class="ai-setting__hint">Comma-separated blocklist. Internal IPs always blocked.</p>
                  <input type="text" class="ai-setting__input" id="setting-web-blocked" value="localhost,127.0.0.1" placeholder="spam.com, ads.net">
                </div>
              </div>
            </div>

            <div style="margin-top: 16px;">
              <button class="btn btn--primary btn--sm" id="save-ai-settings">Save AI Settings</button>
              <span class="ai-settings__status" id="settings-status"></span>
            </div>
          </div>
        </div>

      </div>

      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           Tab 3: Services
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <div class="admin-panel" id="panel-services" role="tabpanel">

        <!-- Communication -->
        <div class="ops-section">
          <h2 class="ops-section__title">üí¨ Communication</h2>
          <div class="admin-services-grid">
            <a href="/admin/services/whatsapp" class="admin-svc-card">
              <div class="admin-svc-card__icon">üí¨</div>
              <div class="admin-svc-card__body">
                <h3 class="admin-svc-card__title">WhatsApp Gateway</h3>
                <p class="admin-svc-card__desc">Multi-tenant messaging via Baileys</p>
              </div>
              <span class="badge badge--checking" data-service="wa"><span class="badge__dot badge__dot--pulse"></span>Checking</span>
            </a>
            <a href="/admin/services/sms" class="admin-svc-card">
              <div class="admin-svc-card__icon">üì±</div>
              <div class="admin-svc-card__body">
                <h3 class="admin-svc-card__title">SMS Gateway</h3>
                <p class="admin-svc-card__desc">Android SMS Gateway ¬∑ multi-tenant</p>
              </div>
              <span class="badge badge--checking" data-service="sms"><span class="badge__dot badge__dot--pulse"></span>Checking</span>
            </a>
            <a href="https://mail.getouch.co" target="_blank" rel="noopener" class="admin-svc-card">
              <div class="admin-svc-card__icon">üìß</div>
              <div class="admin-svc-card__body">
                <h3 class="admin-svc-card__title">Mail Server</h3>
                <p class="admin-svc-card__desc">Mailcow ¬∑ self-hosted SMTP/IMAP</p>
              </div>
              <span class="badge badge--ok"><span class="badge__dot"></span>Self-hosted</span>
            </a>
          </div>
        </div>

        <!-- AI & Compute -->
        <div class="ops-section">
          <h2 class="ops-section__title">ü§ñ AI &amp; Compute</h2>
          <div class="admin-services-grid">
            <a href="/admin/ops#bot" class="admin-svc-card">
              <div class="admin-svc-card__icon">ü§ñ</div>
              <div class="admin-svc-card__body">
                <h3 class="admin-svc-card__title">Bot / AI API</h3>
                <p class="admin-svc-card__desc">Ollama conversational AI service</p>
              </div>
              <span class="badge badge--checking" data-service="bot"><span class="badge__dot badge__dot--pulse"></span>Checking</span>
            </a>
            <div class="admin-svc-card admin-svc-card--disabled">
              <div class="admin-svc-card__icon">üß†</div>
              <div class="admin-svc-card__body">
                <h3 class="admin-svc-card__title">Ollama (LLM)</h3>
                <p class="admin-svc-card__desc">Large language model inference engine</p>
              </div>
              <span class="badge badge--checking" data-service="ollama"><span class="badge__dot badge__dot--pulse"></span>Checking</span>
            </div>
            <div class="admin-svc-card admin-svc-card--disabled">
              <div class="admin-svc-card__icon">üé®</div>
              <div class="admin-svc-card__body">
                <h3 class="admin-svc-card__title">ComfyUI</h3>
                <p class="admin-svc-card__desc">SDXL image generation pipeline</p>
              </div>
              <span class="badge badge--checking" data-service="comfyui"><span class="badge__dot badge__dot--pulse"></span>Checking</span>
            </div>
          </div>
        </div>

        <!-- APIs -->
        <div class="ops-section">
          <h2 class="ops-section__title">‚ö° APIs</h2>
          <div class="admin-services-grid">
            <a href="/admin/ops#api" class="admin-svc-card">
              <div class="admin-svc-card__icon">‚ö°</div>
              <div class="admin-svc-card__body">
                <h3 class="admin-svc-card__title">REST API</h3>
                <p class="admin-svc-card__desc">Programmatic access to platform features</p>
              </div>
              <span class="badge badge--checking" data-service="api"><span class="badge__dot badge__dot--pulse"></span>Checking</span>
            </a>
          </div>
        </div>

        <!-- Database -->
        <div class="ops-section">
          <h2 class="ops-section__title">üóÑÔ∏è Database</h2>
          <div class="admin-services-grid">
            <a href="{{DB_URL}}" target="_blank" rel="noopener" class="admin-svc-card">
              <div class="admin-svc-card__icon">üóÑÔ∏è</div>
              <div class="admin-svc-card__body">
                <h3 class="admin-svc-card__title">pgAdmin</h3>
                <p class="admin-svc-card__desc">PostgreSQL management ¬∑ SSO auto-login</p>
              </div>
              <span class="badge badge--ok"><span class="badge__dot"></span>CF Protected</span>
            </a>
          </div>
        </div>

        <!-- Monitoring -->
        <div class="ops-section">
          <h2 class="ops-section__title">üìä Monitoring</h2>
          <div class="admin-services-grid">
            <a href="https://grafana.getouch.co" target="_blank" rel="noopener" class="admin-svc-card">
              <div class="admin-svc-card__icon">üìä</div>
              <div class="admin-svc-card__body">
                <h3 class="admin-svc-card__title">Grafana</h3>
                <p class="admin-svc-card__desc">Dashboards &amp; metrics ¬∑ SSO auto-login</p>
              </div>
              <span class="badge badge--ok"><span class="badge__dot"></span>CF Protected</span>
            </a>
            <a href="https://metrics.getouch.co" target="_blank" rel="noopener" class="admin-svc-card">
              <div class="admin-svc-card__icon">üìà</div>
              <div class="admin-svc-card__body">
                <h3 class="admin-svc-card__title">Prometheus</h3>
                <p class="admin-svc-card__desc">Metrics collection &amp; alerting</p>
              </div>
              <span class="badge badge--ok"><span class="badge__dot"></span>CF Protected</span>
            </a>
            <a href="https://analytics.getouch.co" target="_blank" rel="noopener" class="admin-svc-card">
              <div class="admin-svc-card__icon">üìâ</div>
              <div class="admin-svc-card__body">
                <h3 class="admin-svc-card__title">Umami</h3>
                <p class="admin-svc-card__desc">Web analytics ¬∑ privacy-first ¬∑ self-hosted</p>
              </div>
              <span class="badge badge--ok"><span class="badge__dot"></span>CF Protected</span>
            </a>
          </div>
        </div>

        <!-- DevOps & CI/CD -->
        <div class="ops-section">
          <h2 class="ops-section__title">üöÄ DevOps &amp; CI/CD</h2>
          <div class="admin-services-grid">
            <a href="https://coolify.getouch.co" target="_blank" rel="noopener" class="admin-svc-card">
              <div class="admin-svc-card__icon">üöÄ</div>
              <div class="admin-svc-card__body">
                <h3 class="admin-svc-card__title">Coolify</h3>
                <p class="admin-svc-card__desc">CI/CD &amp; deployment manager</p>
              </div>
              <span class="badge badge--access">Own Login</span>
            </a>
          </div>
          <div class="info-box" style="margin-top:12px">
            <p class="info-box__text">
              ‚ÑπÔ∏è Coolify uses its own authentication system (Laravel). Cloudflare Access protects the route, 
              but you still need to log in with your Coolify credentials once. The session persists for your browser.
            </p>
          </div>
        </div>

        <!-- Platform -->
        <div class="ops-section">
          <h2 class="ops-section__title">üõ°Ô∏è Platform</h2>
          <div class="admin-services-grid">
            <a href="/" class="admin-svc-card">
              <div class="admin-svc-card__icon">üåê</div>
              <div class="admin-svc-card__body">
                <h3 class="admin-svc-card__title">Landing Page</h3>
                <p class="admin-svc-card__desc">Public landing with AI chat</p>
              </div>
              <span class="badge badge--ok"><span class="badge__dot"></span>Active</span>
            </a>
            <a href="/admin/" class="admin-svc-card">
              <div class="admin-svc-card__icon">üõ°Ô∏è</div>
              <div class="admin-svc-card__body">
                <h3 class="admin-svc-card__title">Admin Portal</h3>
                <p class="admin-svc-card__desc">This dashboard</p>
              </div>
              <span class="badge badge--ok"><span class="badge__dot"></span>Active</span>
            </a>
          </div>
        </div>

      </div>

      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           Tab 4: Infrastructure
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <div class="admin-panel" id="panel-infra" role="tabpanel">

        <!-- Quick Links -->
        <div class="ops-section">
          <h2 class="ops-section__title">Quick Links</h2>
          <div class="health-grid">
            <a href="{{DB_URL}}" target="_blank" rel="noopener" class="health-item health-item--link">
              <div class="health-item__dot health-item__dot--ok"></div>
              <div class="health-item__info">
                <div class="health-item__name" style="color:var(--accent)">pgAdmin</div>
                <div class="health-item__url">db.getouch.co</div>
              </div>
            </a>
            <a href="/admin/ops" class="health-item health-item--link">
              <div class="health-item__dot health-item__dot--ok"></div>
              <div class="health-item__info">
                <div class="health-item__name" style="color:var(--accent)">Ops Dashboard</div>
                <div class="health-item__url">Service links &amp; tools</div>
              </div>
            </a>
            <a href="{{BOT_URL}}/health" target="_blank" rel="noopener" class="health-item health-item--link">
              <div class="health-item__dot health-item__dot--ok"></div>
              <div class="health-item__info">
                <div class="health-item__name" style="color:var(--accent)">Bot Health</div>
                <div class="health-item__url">bot.getouch.co/health</div>
              </div>
            </a>
            <a href="{{WA_URL}}/health" target="_blank" rel="noopener" class="health-item health-item--link">
              <div class="health-item__dot health-item__dot--ok"></div>
              <div class="health-item__info">
                <div class="health-item__name" style="color:var(--accent)">WA Health</div>
                <div class="health-item__url">wa.getouch.co/health</div>
              </div>
            </a>
            <a href="https://coolify.getouch.co" target="_blank" rel="noopener" class="health-item health-item--link">
              <div class="health-item__dot health-item__dot--ok"></div>
              <div class="health-item__info">
                <div class="health-item__name" style="color:var(--accent)">Coolify</div>
                <div class="health-item__url">coolify.getouch.co</div>
              </div>
            </a>
            <a href="https://grafana.getouch.co" target="_blank" rel="noopener" class="health-item health-item--link">
              <div class="health-item__dot health-item__dot--ok"></div>
              <div class="health-item__info">
                <div class="health-item__name" style="color:var(--accent)">Grafana</div>
                <div class="health-item__url">grafana.getouch.co</div>
              </div>
            </a>
            <a href="https://analytics.getouch.co" target="_blank" rel="noopener" class="health-item health-item--link">
              <div class="health-item__dot health-item__dot--ok"></div>
              <div class="health-item__info">
                <div class="health-item__name" style="color:var(--accent)">Umami Analytics</div>
                <div class="health-item__url">analytics.getouch.co</div>
              </div>
            </a>
            <a href="https://mail.getouch.co" target="_blank" rel="noopener" class="health-item health-item--link">
              <div class="health-item__dot health-item__dot--ok"></div>
              <div class="health-item__info">
                <div class="health-item__name" style="color:var(--accent)">Mailcow</div>
                <div class="health-item__url">mail.getouch.co</div>
              </div>
            </a>
          </div>
        </div>

        <!-- Mail Server (Mailcow) -->
        <div class="ops-section">
          <h2 class="ops-section__title">üìß Mail Server</h2>
          <div class="ops-card">
            <div class="info-box" style="border-left-color: var(--green);">
              <div class="info-box__title">Mailcow ‚Äî Self-Hosted Mail (72.62.253.182)</div>
              <p class="info-box__text">
                Full mail infrastructure for <strong>@getouch.co</strong> ‚Äî SMTP, IMAP, webmail, antispam (Rspamd), DKIM signing.
                Running as Docker containers on the mail VPS. Admin UI at <strong>mail.getouch.co</strong>.
              </p>
            </div>
            <div class="ops-links" style="margin-top:12px;">
              <a href="https://mail.getouch.co" target="_blank" rel="noopener" class="ops-link">
                <span class="ops-link__label">üìß Mailcow Admin UI</span>
                <span class="ops-link__url">mail.getouch.co ‚Äî domain, mailbox &amp; alias management</span>
                <span class="badge badge--ok"><span class="badge__dot"></span>Self-hosted</span>
              </a>
              <a href="https://dash.cloudflare.com/?to=/:account/getouch.co/dns" target="_blank" rel="noopener" class="ops-link">
                <span class="ops-link__label">üåê DNS Records</span>
                <span class="ops-link__url">Cloudflare DNS ‚Äî MX, SPF, DKIM, DMARC</span>
                <span class="badge badge--access">CF Dashboard</span>
              </a>
              <a href="https://dash.cloudflare.com/?to=/:account/getouch.co/email/routing/routes" target="_blank" rel="noopener" class="ops-link">
                <span class="ops-link__label">üì® Legacy Email Routing</span>
                <span class="ops-link__url">Cloudflare Email Routing (disabled after cutover)</span>
                <span class="badge badge--tailscale">Legacy</span>
              </a>
            </div>
            <div style="margin-top:12px; padding:12px 16px; background:var(--bg); border:1px solid var(--border); border-radius:var(--radius-sm);">
              <p style="font-size:.78rem; color:var(--text-muted); margin-bottom:8px;">
                <strong>Mailboxes &amp; Aliases:</strong>
              </p>
              <table style="width:100%; font-size:.75rem; color:var(--text-muted); border-collapse:collapse;">
                <thead>
                  <tr style="border-bottom:1px solid var(--border);">
                    <th style="text-align:left; padding:6px 8px; color:var(--text-dim); font-weight:600;">Address</th>
                    <th style="text-align:left; padding:6px 8px; color:var(--text-dim); font-weight:600;">Type</th>
                    <th style="text-align:left; padding:6px 8px; color:var(--text-dim); font-weight:600;">Status</th>
                  </tr>
                </thead>
                <tbody>
                  <tr style="border-bottom:1px solid var(--border);">
                    <td style="padding:6px 8px; font-family:var(--font-mono);">admin@getouch.co</td>
                    <td style="padding:6px 8px;">Mailbox (IMAP/SMTP)</td>
                    <td style="padding:6px 8px;"><span class="badge badge--ok" style="font-size:.65rem;"><span class="badge__dot"></span>Active</span></td>
                  </tr>
                  <tr style="border-bottom:1px solid var(--border);">
                    <td style="padding:6px 8px; font-family:var(--font-mono);">support@getouch.co</td>
                    <td style="padding:6px 8px;">Mailbox (IMAP/SMTP)</td>
                    <td style="padding:6px 8px;"><span class="badge badge--ok" style="font-size:.65rem;"><span class="badge__dot"></span>Active</span></td>
                  </tr>
                  <tr style="border-bottom:1px solid var(--border);">
                    <td style="padding:6px 8px; font-family:var(--font-mono);">noreply@getouch.co</td>
                    <td style="padding:6px 8px;">Alias ‚Üí admin@getouch.co</td>
                    <td style="padding:6px 8px;"><span class="badge badge--ok" style="font-size:.65rem;"><span class="badge__dot"></span>Active</span></td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div style="margin-top:12px; padding:12px 16px; background:var(--bg); border:1px solid var(--border); border-radius:var(--radius-sm);">
              <p style="font-size:.78rem; color:var(--text-muted); margin-bottom:8px;">
                <strong>DNS Records (Cloudflare ‚Äî grey-cloud / DNS only):</strong>
              </p>
              <table style="width:100%; font-size:.72rem; color:var(--text-muted); border-collapse:collapse; font-family:var(--font-mono);">
                <thead>
                  <tr style="border-bottom:1px solid var(--border);">
                    <th style="text-align:left; padding:4px 6px; color:var(--text-dim); font-weight:600;">Type</th>
                    <th style="text-align:left; padding:4px 6px; color:var(--text-dim); font-weight:600;">Name</th>
                    <th style="text-align:left; padding:4px 6px; color:var(--text-dim); font-weight:600;">Value</th>
                  </tr>
                </thead>
                <tbody>
                  <tr style="border-bottom:1px solid var(--border);">
                    <td style="padding:4px 6px;">A</td>
                    <td style="padding:4px 6px;">mail</td>
                    <td style="padding:4px 6px;">72.62.253.182</td>
                  </tr>
                  <tr style="border-bottom:1px solid var(--border);">
                    <td style="padding:4px 6px;">MX</td>
                    <td style="padding:4px 6px;">@</td>
                    <td style="padding:4px 6px;">mail.getouch.co (priority 10)</td>
                  </tr>
                  <tr style="border-bottom:1px solid var(--border);">
                    <td style="padding:4px 6px;">TXT</td>
                    <td style="padding:4px 6px;">@</td>
                    <td style="padding:4px 6px;">v=spf1 a mx ip4:72.62.253.182 ~all</td>
                  </tr>
                  <tr style="border-bottom:1px solid var(--border);">
                    <td style="padding:4px 6px;">TXT</td>
                    <td style="padding:4px 6px;">dkim._domainkey</td>
                    <td style="padding:4px 6px; word-break:break-all;">v=DKIM1;k=rsa;t=s;s=email;p=...</td>
                  </tr>
                  <tr>
                    <td style="padding:4px 6px;">TXT</td>
                    <td style="padding:4px 6px;">_dmarc</td>
                    <td style="padding:4px 6px;">v=DMARC1; p=none; rua=mailto:admin@getouch.co</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- SSO Status -->
        <div class="ops-section">
          <h2 class="ops-section__title">üîê SSO &amp; Access Status</h2>
          <div class="ops-card">
            <div class="ops-links">
              <div class="ops-link">
                <span class="ops-link__label">Grafana</span>
                <span class="ops-link__url">Auth proxy via X-WEBAUTH-USER header</span>
                <span class="badge badge--ok"><span class="badge__dot"></span>Auto-login</span>
              </div>
              <div class="ops-link">
                <span class="ops-link__label">pgAdmin</span>
                <span class="ops-link__url">Webserver auth via REMOTE_USER header</span>
                <span class="badge badge--ok"><span class="badge__dot"></span>Auto-login</span>
              </div>
              <div class="ops-link">
                <span class="ops-link__label">Prometheus</span>
                <span class="ops-link__url">No internal auth ¬∑ CF Access gate only</span>
                <span class="badge badge--ok"><span class="badge__dot"></span>No login</span>
              </div>
              <div class="ops-link">
                <span class="ops-link__label">Umami</span>
                <span class="ops-link__url">Own auth (admin/umami default) ¬∑ CF Access gate</span>
                <span class="badge badge--access">Own Login</span>
              </div>
              <div class="ops-link">
                <span class="ops-link__label">Coolify</span>
                <span class="ops-link__url">Own Laravel auth ¬∑ CF Access + own login</span>
                <span class="badge badge--access">Own Login</span>
              </div>
              <div class="ops-link">
                <span class="ops-link__label">Mailcow</span>
                <span class="ops-link__url">Own admin UI ¬∑ admin/moohoo (change on first login)</span>
                <span class="badge badge--access">Own Login</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Useful Commands -->
        <div class="ops-section">
          <h2 class="ops-section__title">üñ•Ô∏è Server Commands</h2>
          <pre class="code-block">ssh deploy@100.103.248.15
cd /opt/getouch/compose
docker compose logs -f caddy --tail 100
docker compose -f docker-compose.apps.yml logs -f --tail 100

# Restart a specific service
docker compose -f docker-compose.apps.yml restart bot
docker compose -f docker-compose.apps.yml restart wa
docker compose -f docker-compose.apps.yml restart api

# Check service status
docker compose -f docker-compose.apps.yml ps

# Restart pgAdmin (after SSO config change)
docker compose -f docker-compose.db.yml restart pgadmin

# Check Caddy logs (for SSO header issues)
docker compose logs caddy --tail 50 | grep -i "remote\|auth"

# ‚îÄ‚îÄ Mail Server (72.62.253.182) ‚îÄ‚îÄ
ssh -i ~/.ssh/id_ed25519 deploy@72.62.253.182
cd /opt/mailcow-dockerized
docker compose ps                    # container status
docker compose logs -f --tail 100    # all mail logs
docker compose logs postfix-mailcow --tail 50   # SMTP logs
docker compose logs dovecot-mailcow --tail 50   # IMAP logs
docker compose logs nginx-mailcow --tail 50     # webmail proxy
docker compose restart               # restart all
echo 'Turun@202020' | sudo -S certbot certificates  # check TLS</pre>
        </div>

      </div>

      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           Tab 5: Users
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <div class="admin-panel" id="panel-users" role="tabpanel">

        <!-- User Stats Cards -->
        <div class="ops-section">
          <h2 class="ops-section__title">Registered Users</h2>
          <div class="user-stats-grid" id="user-stats-grid">
            <div class="user-stat-card">
              <div class="user-stat-card__value" id="stat-total">‚Äî</div>
              <div class="user-stat-card__label">Total Users</div>
            </div>
            <div class="user-stat-card">
              <div class="user-stat-card__value" id="stat-active">‚Äî</div>
              <div class="user-stat-card__label">Active</div>
            </div>
            <div class="user-stat-card">
              <div class="user-stat-card__value" id="stat-verified">‚Äî</div>
              <div class="user-stat-card__label">Verified</div>
            </div>
            <div class="user-stat-card">
              <div class="user-stat-card__value" id="stat-7d">‚Äî</div>
              <div class="user-stat-card__label">New (7d)</div>
            </div>
            <div class="user-stat-card">
              <div class="user-stat-card__value" id="stat-30d">‚Äî</div>
              <div class="user-stat-card__label">New (30d)</div>
            </div>
            <div class="user-stat-card">
              <div class="user-stat-card__value" id="stat-google">‚Äî</div>
              <div class="user-stat-card__label">Google OAuth</div>
            </div>
            <div class="user-stat-card">
              <div class="user-stat-card__value" id="stat-facebook">‚Äî</div>
              <div class="user-stat-card__label">Facebook OAuth</div>
            </div>
          </div>
        </div>

        <!-- Search & User Table -->
        <div class="ops-section">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
            <input type="text" class="ai-setting__input" id="user-search" placeholder="Search by email or name..."
                   style="max-width:320px;padding:8px 14px;font-size:.82rem;">
            <button class="btn btn--ghost btn--sm" id="user-search-btn" style="padding:8px 16px;">Search</button>
          </div>
          <div style="overflow-x:auto;">
            <table class="user-table" id="user-table">
              <thead>
                <tr>
                  <th>User</th>
                  <th>Email</th>
                  <th>Provider</th>
                  <th>Status</th>
                  <th>Registered</th>
                </tr>
              </thead>
              <tbody id="user-table-body">
                <tr><td colspan="5" style="text-align:center;color:var(--text-dim);padding:24px;">Loading users‚Ä¶</td></tr>
              </tbody>
            </table>
          </div>
          <div class="user-pagination" id="user-pagination" style="margin-top:12px;"></div>
        </div>

      </div>

      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           Tab 6: Reporting
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <div class="admin-panel" id="panel-reporting" role="tabpanel">

        <!-- Time Range Selector -->
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:20px;">
          <span style="font-size:.8rem;color:var(--text-muted);font-weight:600;">Period:</span>
          <button class="btn btn--ghost btn--sm rpt-range active" data-days="1" style="padding:4px 12px;font-size:.75rem;">Today</button>
          <button class="btn btn--ghost btn--sm rpt-range" data-days="7" style="padding:4px 12px;font-size:.75rem;">7 Days</button>
          <button class="btn btn--ghost btn--sm rpt-range" data-days="30" style="padding:4px 12px;font-size:.75rem;">30 Days</button>
          <button class="btn btn--ghost btn--sm rpt-range" data-days="90" style="padding:4px 12px;font-size:.75rem;">90 Days</button>
          <button class="btn btn--ghost btn--sm" id="rpt-refresh" style="padding:4px 12px;font-size:.75rem;margin-left:auto;">‚Üª Refresh</button>
        </div>

        <!-- Summary KPI Cards -->
        <div class="ops-section">
          <h2 class="ops-section__title">Overview</h2>
          <div class="user-stats-grid" id="rpt-summary-grid" style="grid-template-columns:repeat(auto-fill,minmax(130px,1fr));">
            <div class="user-stat-card">
              <div class="user-stat-card__value" id="rpt-total-events">‚Äî</div>
              <div class="user-stat-card__label">Total Events</div>
            </div>
            <div class="user-stat-card">
              <div class="user-stat-card__value" id="rpt-total-chats">‚Äî</div>
              <div class="user-stat-card__label">Chats</div>
            </div>
            <div class="user-stat-card">
              <div class="user-stat-card__value" id="rpt-total-images">‚Äî</div>
              <div class="user-stat-card__label">Images</div>
            </div>
            <div class="user-stat-card">
              <div class="user-stat-card__value" id="rpt-unique-visitors">‚Äî</div>
              <div class="user-stat-card__label">Visitors</div>
            </div>
            <div class="user-stat-card">
              <div class="user-stat-card__value" id="rpt-registered-users">‚Äî</div>
              <div class="user-stat-card__label">Registered</div>
            </div>
            <div class="user-stat-card">
              <div class="user-stat-card__value" id="rpt-guest-events">‚Äî</div>
              <div class="user-stat-card__label">Guest Events</div>
            </div>
            <div class="user-stat-card">
              <div class="user-stat-card__value" id="rpt-tokens-total">‚Äî</div>
              <div class="user-stat-card__label">Tokens (in+out)</div>
            </div>
          </div>

          <!-- Today mini-row -->
          <div style="display:flex;gap:16px;margin-top:12px;flex-wrap:wrap;" id="rpt-today-row">
            <span style="font-size:.75rem;color:var(--text-muted);">Today: <strong id="rpt-today-chats">‚Äî</strong> chats ¬∑ <strong id="rpt-today-images">‚Äî</strong> images ¬∑ <strong id="rpt-today-visitors">‚Äî</strong> visitors</span>
          </div>
        </div>

        <!-- Daily Chart -->
        <div class="ops-section">
          <h2 class="ops-section__title">Daily Activity</h2>
          <div id="rpt-chart" style="display:flex;align-items:flex-end;gap:2px;height:180px;padding:8px 0;overflow-x:auto;"></div>
          <div id="rpt-chart-labels" style="display:flex;gap:2px;font-size:.6rem;color:var(--text-dim);overflow-x:auto;"></div>
          <div style="display:flex;gap:16px;margin-top:8px;">
            <span style="font-size:.7rem;display:flex;align-items:center;gap:4px;"><span style="width:10px;height:10px;border-radius:2px;background:var(--accent);display:inline-block;"></span> Chats</span>
            <span style="font-size:.7rem;display:flex;align-items:center;gap:4px;"><span style="width:10px;height:10px;border-radius:2px;background:#f59e0b;display:inline-block;"></span> Images</span>
          </div>
        </div>

        <!-- Breakdown Section -->
        <div class="ops-section">
          <h2 class="ops-section__title">Breakdown</h2>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">

            <!-- By Mode -->
            <div>
              <h3 style="font-size:.8rem;font-weight:600;color:var(--text-muted);margin-bottom:8px;">By Mode</h3>
              <div id="rpt-by-mode" style="font-size:.78rem;color:var(--text-muted);">Loading‚Ä¶</div>
            </div>

            <!-- By Model -->
            <div>
              <h3 style="font-size:.8rem;font-weight:600;color:var(--text-muted);margin-bottom:8px;">By Model</h3>
              <div id="rpt-by-model" style="font-size:.78rem;color:var(--text-muted);">Loading‚Ä¶</div>
            </div>
          </div>

          <!-- Error Rate -->
          <div style="margin-top:16px;padding:10px 16px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);">
            <span style="font-size:.78rem;color:var(--text-muted);">Error rate: <strong id="rpt-error-rate">‚Äî</strong></span>
          </div>
        </div>

        <!-- Top Visitors -->
        <div class="ops-section">
          <h2 class="ops-section__title">Top Visitors</h2>
          <div style="overflow-x:auto;">
            <table class="user-table" style="font-size:.78rem;">
              <thead>
                <tr>
                  <th>Visitor</th>
                  <th>Type</th>
                  <th>Chats</th>
                  <th>Images</th>
                  <th>Total</th>
                  <th>First Seen</th>
                  <th>Last Active</th>
                </tr>
              </thead>
              <tbody id="rpt-visitors-body">
                <tr><td colspan="7" style="text-align:center;color:var(--text-dim);padding:24px;">Loading‚Ä¶</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Guest Limits Config -->
        <div class="ops-section">
          <h2 class="ops-section__title">Guest Limits</h2>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
            <div class="ai-setting">
              <label class="ai-setting__label">Chat / Hour</label>
              <p class="ai-setting__hint">Max chat messages per hour for anonymous guests.</p>
              <input type="number" class="ai-setting__input" id="rpt-guest-chat-hour" value="20" min="1" max="1000">
            </div>
            <div class="ai-setting">
              <label class="ai-setting__label">Images / Day</label>
              <p class="ai-setting__hint">Max image generations per day for guests.</p>
              <input type="number" class="ai-setting__input" id="rpt-guest-images-day" value="3" min="0" max="1000">
            </div>
            <div class="ai-setting">
              <label class="ai-setting__label">Soft Gate after Chats</label>
              <p class="ai-setting__hint">Show registration prompt after N guest chats.</p>
              <input type="number" class="ai-setting__input" id="rpt-gate-chats" value="5" min="1" max="100">
            </div>
            <div class="ai-setting">
              <label class="ai-setting__label">Soft Gate after Images</label>
              <p class="ai-setting__hint">Show registration prompt after N guest images.</p>
              <input type="number" class="ai-setting__input" id="rpt-gate-images" value="2" min="0" max="100">
            </div>
          </div>

          <div style="display:flex;align-items:center;gap:12px;margin-top:12px;">
            <span style="font-size:.75rem;color:var(--text-muted);">
              Active guests (1h): <strong id="rpt-active-guests">‚Äî</strong> ¬∑
              Guest chats (1h): <strong id="rpt-guest-chats-1h">‚Äî</strong> ¬∑
              Guest images (today): <strong id="rpt-guest-images-today">‚Äî</strong>
            </span>
          </div>

          <div style="margin-top:12px;">
            <button class="btn btn--primary btn--sm" id="rpt-save-guest">Save Guest Limits</button>
            <span class="ai-settings__status" id="rpt-guest-status"></span>
          </div>
        </div>

      </div>

    </div>
  </div>

  <script src="/js/app.js?v={{VERSION}}"></script>
  <script>
  (function() {
    'use strict';

    /* ‚îÄ‚îÄ Tab switching ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    var tabs   = document.querySelectorAll('.admin-tab');
    var panels = document.querySelectorAll('.admin-panel');

    // Restore last active tab from sessionStorage
    var savedTab = sessionStorage.getItem('admin_active_tab') || 'overview';

    function activateTab(tabName) {
      tabs.forEach(function(t) {
        var isActive = t.dataset.tab === tabName;
        t.classList.toggle('active', isActive);
        t.setAttribute('aria-selected', isActive ? 'true' : 'false');
      });
      panels.forEach(function(p) {
        p.classList.toggle('active', p.id === 'panel-' + tabName);
      });
      sessionStorage.setItem('admin_active_tab', tabName);
    }

    tabs.forEach(function(tab) {
      tab.addEventListener('click', function() {
        activateTab(this.dataset.tab);
      });
    });

    // Restore saved tab
    activateTab(savedTab);

    // Support keyboard navigation between tabs
    document.querySelector('.admin-tabs').addEventListener('keydown', function(e) {
      var tabArr = Array.from(tabs);
      var idx = tabArr.indexOf(document.activeElement);
      if (idx === -1) return;

      if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
        e.preventDefault();
        var nextIdx = e.key === 'ArrowRight'
          ? (idx + 1) % tabArr.length
          : (idx - 1 + tabArr.length) % tabArr.length;
        tabArr[nextIdx].focus();
        activateTab(tabArr[nextIdx].dataset.tab);
      }
    });

    /* ‚îÄ‚îÄ Health checking ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    function checkHealth() {
      fetch('/api/status')
        .then(function(r) { return r.json(); })
        .then(function(data) {
          var offlineServices = [];
          var onlineCount = 0;
          var totalCount = 0;

          Object.entries(data.services).forEach(function(pair) {
            var name = pair[0];
            var svc = pair[1];
            totalCount++;

            // Update health grid
            var dot = document.querySelector('#health-' + name + ' .health-item__dot');
            var url = document.querySelector('#health-' + name + ' .health-item__url');
            var lat = document.getElementById('lat-' + name);

            if (dot) {
              dot.className = 'health-item__dot health-item__dot--' + (svc.status === 'ok' ? 'ok' : 'offline');
            }
            if (url) {
              var detail = svc.status;
              if (svc.version) detail = 'v' + svc.version;
              if (svc.model) detail += ' ¬∑ ' + svc.model;
              url.textContent = detail;
            }
            if (lat && svc.latency_ms !== undefined) {
              lat.textContent = svc.latency_ms + 'ms';
            }

            // Update service cards
            var badges = document.querySelectorAll('[data-service="' + name + '"]');
            badges.forEach(function(el) {
              if (svc.status === 'ok') {
                el.className = 'badge badge--ok';
                el.innerHTML = '<span class="badge__dot"></span>Online';
              } else {
                el.className = 'badge badge--offline';
                el.innerHTML = '<span class="badge__dot"></span>Offline';
              }
            });

            if (svc.status === 'ok') {
              onlineCount++;
            } else {
              offlineServices.push(name);
            }
          });

          // Show offline info box
          var infoBox = document.getElementById('health-info');
          var infoText = document.getElementById('health-info-text');
          if (offlineServices.length > 0 && infoBox && infoText) {
            infoBox.style.display = 'block';
            var reasons = offlineServices.map(function(s) {
              var svc = data.services[s];
              var detail = '<strong>' + s.toUpperCase() + '</strong>: ';
              if (svc.latency_ms < 50) {
                detail += 'Connection refused (service not running). Check with: <code style="color:var(--accent)">docker compose -f docker-compose.apps.yml ps ' + s + '</code>';
              } else if (svc.latency_ms >= 2000) {
                detail += 'Timeout after ' + svc.latency_ms + 'ms (service unreachable or DNS issue).';
              } else {
                detail += 'Responded in ' + svc.latency_ms + 'ms but returned error. Check service logs.';
              }
              return detail;
            });
            infoText.innerHTML = reasons.join('<br><br>') +
              '<br><br><span style="color:var(--text-dim)">Tip: In local development, services (bot, wa, api) run as Docker containers. They appear offline when their Docker containers are not running. SSH into the server and restart them.</span>';
          } else if (infoBox) {
            infoBox.style.display = 'none';
          }

          // Update activity log
          var actTime = document.getElementById('activity-time');
          var actSummary = document.getElementById('activity-summary');
          if (actTime) actTime.textContent = new Date().toLocaleTimeString();
          if (actSummary) {
            actSummary.textContent = onlineCount + '/' + (totalCount + 1) + ' services online' +
              (offlineServices.length > 0 ? '. Offline: ' + offlineServices.join(', ') : '. All services healthy.');
          }
        })
        .catch(function() {});
    }

    // SMS health (separate endpoint)
    function checkSmsHealth() {
      fetch('/v1/sms/health')
        .then(function(r){ return r.json(); })
        .then(function(d){
          var badges = document.querySelectorAll('[data-service="sms"]');
          var s = d.status;
          badges.forEach(function(el){
            if(s === 'online'){
              el.className = 'badge badge--ok';
              el.innerHTML = '<span class="badge__dot"></span>Online';
            } else if(s === 'degraded'){
              el.className = 'badge badge--warn';
              el.innerHTML = '<span class="badge__dot"></span>Degraded';
            } else {
              el.className = 'badge badge--offline';
              el.innerHTML = '<span class="badge__dot"></span>Offline';
            }
          });
        })
        .catch(function(){
          var badges = document.querySelectorAll('[data-service="sms"]');
          badges.forEach(function(el){
            el.className = 'badge badge--offline';
            el.innerHTML = '<span class="badge__dot"></span>Offline';
          });
        });
    }

    // Run immediately and every 30 seconds
    checkHealth();
    checkSmsHealth();
    setInterval(checkHealth, 30000);
    setInterval(checkSmsHealth, 30000);

    /* ‚îÄ‚îÄ AI Settings management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    var modelSelect  = document.getElementById('setting-default-model');
    var visionSelect = document.getElementById('setting-vision-model');
    var imageToggle  = document.getElementById('setting-enable-image');
    var toggleText   = document.getElementById('toggle-text');
    var imageEngine  = document.getElementById('setting-image-engine');
    var maxImagesProd = document.getElementById('setting-max-images-prod');
    var maxImagesDev  = document.getElementById('setting-max-images-dev');
    var rateChatProd  = document.getElementById('setting-rate-chat-prod');
    var rateChatDev   = document.getElementById('setting-rate-chat-dev');
    var rateImageProd = document.getElementById('setting-rate-image-prod');
    var rateImageDev  = document.getElementById('setting-rate-image-dev');
    var saveBtn      = document.getElementById('save-ai-settings');
    var statusEl     = document.getElementById('settings-status');

    // Load available models from Ollama
    function loadModels() {
      fetch('/v1/chat/models')
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (!data.models) return;
          modelSelect.innerHTML = '';
          visionSelect.innerHTML = '<option value="">(none ‚Äî text model fallback)</option>';
          data.models.forEach(function(m) {
            var sizeLabel = m.size_gb ? ' (' + m.size_gb + ' GB)' : '';
            var visionTag = m.is_vision ? ' [Vision]' : '';
            var opt = document.createElement('option');
            opt.value = m.id;
            opt.textContent = m.id + sizeLabel + visionTag;
            modelSelect.appendChild(opt);
            // Add all models to vision dropdown too, but mark vision ones
            var vopt = document.createElement('option');
            vopt.value = m.id;
            vopt.textContent = m.id + sizeLabel + visionTag;
            visionSelect.appendChild(vopt);
          });
          // Set saved values
          if (data.default_model) modelSelect.value = data.default_model;
          if (data.default_vision_model) visionSelect.value = data.default_vision_model;
        })
        .catch(function() {
          modelSelect.innerHTML = '<option value="llama3.1:8b">llama3.1:8b</option>';
          visionSelect.innerHTML = '<option value="">(none)</option>';
        });
    }
    loadModels();

    // Typing settings elements
    var typingEnabled  = document.getElementById('setting-typing-enabled');
    var typingTogText  = document.getElementById('typing-toggle-text');
    var typingMode     = document.getElementById('setting-typing-mode');
    var typingSpeed    = document.getElementById('setting-typing-speed');
    var typingAdaptive = document.getElementById('setting-typing-adaptive');
    var typingAdpText  = document.getElementById('typing-adaptive-text');
    var typingDetails  = document.getElementById('typing-detail-settings');

    // Web research settings elements
    var webEnabled    = document.getElementById('setting-web-enabled');
    var webTogText    = document.getElementById('web-toggle-text');
    var webProvider   = document.getElementById('setting-web-provider');
    var webSearxUrl   = document.getElementById('setting-web-searxng-url');
    var webSearxSetting = document.getElementById('web-searxng-url-setting');
    var webMaxSources = document.getElementById('setting-web-max-sources');
    var webMaxFetch   = document.getElementById('setting-web-max-fetch');
    var webCacheTtl   = document.getElementById('setting-web-cache-ttl');
    var webTimeout    = document.getElementById('setting-web-timeout');
    var webAllowed    = document.getElementById('setting-web-allowed');
    var webBlocked    = document.getElementById('setting-web-blocked');
    var webDetails    = document.getElementById('web-research-details');

    // Personality & routing elements
    var personalityEnabled = document.getElementById('setting-personality-enabled');
    var personalityTogText = document.getElementById('personality-toggle-text');
    var dialectEnabled     = document.getElementById('setting-dialect-mirroring');
    var dialectTogText     = document.getElementById('dialect-toggle-text');
    var stabilizerEnabled  = document.getElementById('setting-stabilizer-enabled');
    var stabilizerTogText  = document.getElementById('stabilizer-toggle-text');
    var dialectLevel       = document.getElementById('setting-dialect-level');
    var smalltalkTokens    = document.getElementById('setting-smalltalk-tokens');
    var generalTokens      = document.getElementById('setting-general-tokens');
    var taskTokens         = document.getElementById('setting-task-tokens');

    // Guest limits elements
    var guestChatDay     = document.getElementById('setting-guest-chat-day');
    var guestDocDay      = document.getElementById('setting-guest-doc-day');
    var guestImageDay    = document.getElementById('setting-guest-image-day');
    var guestRegisterN   = document.getElementById('setting-guest-register-n');

    // Document limits elements
    var maxFileMb          = document.getElementById('setting-max-file-mb');
    var pdfPagesGuest      = document.getElementById('setting-pdf-pages-guest');
    var pdfPagesRegistered = document.getElementById('setting-pdf-pages-registered');

    // Load current settings
    function loadSettings() {
      fetch('/v1/admin/settings')
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (!data.settings) return;
          var s = data.settings;
          if (s['ai.default_text_model']) modelSelect.value = s['ai.default_text_model'];
          if (s['ai.default_vision_model']) visionSelect.value = s['ai.default_vision_model'];
          if (s['ai.enable_image'] !== undefined) {
            imageToggle.checked = !!s['ai.enable_image'];
            toggleText.textContent = imageToggle.checked ? 'Enabled' : 'Disabled';
          }
          if (s['ai.default_image_engine']) imageEngine.value = s['ai.default_image_engine'];
          if (s['ai.image.max_per_day_free.prod'] !== undefined) maxImagesProd.value = s['ai.image.max_per_day_free.prod'];
          if (s['ai.image.max_per_day_free.dev'] !== undefined) maxImagesDev.value = s['ai.image.max_per_day_free.dev'];
          if (s['rate_limit.chat.prod'] !== undefined) rateChatProd.value = s['rate_limit.chat.prod'];
          if (s['rate_limit.chat.dev'] !== undefined) rateChatDev.value = s['rate_limit.chat.dev'];
          if (s['rate_limit.image.prod'] !== undefined) rateImageProd.value = s['rate_limit.image.prod'];
          if (s['rate_limit.image.dev'] !== undefined) rateImageDev.value = s['rate_limit.image.dev'];
          // Typing settings
          if (s['typing.enabled'] !== undefined) {
            typingEnabled.checked = !!s['typing.enabled'];
            typingTogText.textContent = typingEnabled.checked ? 'Enabled' : 'Disabled';
            typingDetails.style.display = typingEnabled.checked ? '' : 'none';
          }
          if (s['typing.mode']) typingMode.value = s['typing.mode'];
          if (s['typing.speed'] !== undefined) typingSpeed.value = s['typing.speed'];
          if (s['typing.adaptive_catchup'] !== undefined) {
            typingAdaptive.checked = !!s['typing.adaptive_catchup'];
            typingAdpText.textContent = typingAdaptive.checked ? 'Enabled' : 'Disabled';
          }
          // Web research settings
          if (s['web_research.enabled'] !== undefined) {
            var webOn = s['web_research.enabled'] === true || s['web_research.enabled'] === 'true';
            webEnabled.checked = webOn;
            webTogText.textContent = webOn ? 'Enabled' : 'Disabled';
            webDetails.style.display = webOn ? '' : 'none';
          }
          if (s['web_research.search_provider']) webProvider.value = s['web_research.search_provider'];
          if (s['web_research.searxng_url']) webSearxUrl.value = s['web_research.searxng_url'];
          if (s['web_research.max_sources'] !== undefined) webMaxSources.value = s['web_research.max_sources'];
          if (s['web_research.max_fetch'] !== undefined) webMaxFetch.value = s['web_research.max_fetch'];
          if (s['web_research.cache_ttl_minutes'] !== undefined) webCacheTtl.value = s['web_research.cache_ttl_minutes'];
          if (s['web_research.timeout_seconds'] !== undefined) webTimeout.value = s['web_research.timeout_seconds'];
          if (s['web_research.allowed_domains'] !== undefined) webAllowed.value = s['web_research.allowed_domains'];
          if (s['web_research.blocked_domains'] !== undefined) webBlocked.value = s['web_research.blocked_domains'];
          // Show/hide SearXNG URL based on provider
          webSearxSetting.style.display = webProvider.value === 'searxng' ? '' : 'none';
          // Personality & routing settings
          if (s['ai.personality_enabled'] !== undefined) {
            var pOn = s['ai.personality_enabled'] === true || s['ai.personality_enabled'] === 'true';
            personalityEnabled.checked = pOn;
            personalityTogText.textContent = pOn ? 'Enabled' : 'Disabled';
          }
          if (s['ai.dialect_mirroring'] !== undefined) {
            var dOn = s['ai.dialect_mirroring'] === true || s['ai.dialect_mirroring'] === 'true';
            dialectEnabled.checked = dOn;
            dialectTogText.textContent = dOn ? 'Enabled' : 'Disabled';
          }
          if (s['ai.smalltalk_max_tokens'] !== undefined) smalltalkTokens.value = s['ai.smalltalk_max_tokens'];
          if (s['ai.general_max_tokens'] !== undefined) generalTokens.value = s['ai.general_max_tokens'];
          if (s['ai.task_max_tokens'] !== undefined) taskTokens.value = s['ai.task_max_tokens'];
          // Stabilizer & dialect level
          if (s['ai.smalltalk_stabilizer'] !== undefined) {
            var stOn = s['ai.smalltalk_stabilizer'] === true || s['ai.smalltalk_stabilizer'] === 'true';
            stabilizerEnabled.checked = stOn;
            stabilizerTogText.textContent = stOn ? 'Enabled' : 'Disabled';
          }
          if (s['ai.dialect_mirroring_level']) dialectLevel.value = s['ai.dialect_mirroring_level'];
          // Guest limits
          if (s['guest.chat_per_day'] !== undefined) guestChatDay.value = s['guest.chat_per_day'];
          if (s['guest.doc_per_day'] !== undefined) guestDocDay.value = s['guest.doc_per_day'];
          if (s['guest.image_per_day'] !== undefined) guestImageDay.value = s['guest.image_per_day'];
          if (s['guest.require_register_after_n'] !== undefined) guestRegisterN.value = s['guest.require_register_after_n'];
          // Document limits
          if (s['limits.max_file_size_mb'] !== undefined) maxFileMb.value = s['limits.max_file_size_mb'];
          if (s['limits.max_pdf_pages_guest'] !== undefined) pdfPagesGuest.value = s['limits.max_pdf_pages_guest'];
          if (s['limits.max_pdf_pages_registered'] !== undefined) pdfPagesRegistered.value = s['limits.max_pdf_pages_registered'];
        })
        .catch(function() {});
    }
    loadSettings();

    imageToggle.addEventListener('change', function() {
      toggleText.textContent = this.checked ? 'Enabled' : 'Disabled';
    });

    typingEnabled.addEventListener('change', function() {
      typingTogText.textContent = this.checked ? 'Enabled' : 'Disabled';
      typingDetails.style.display = this.checked ? '' : 'none';
    });
    typingAdaptive.addEventListener('change', function() {
      typingAdpText.textContent = this.checked ? 'Enabled' : 'Disabled';
    });

    // Web research toggle handlers
    webEnabled.addEventListener('change', function() {
      webTogText.textContent = this.checked ? 'Enabled' : 'Disabled';
      webDetails.style.display = this.checked ? '' : 'none';
    });
    webProvider.addEventListener('change', function() {
      webSearxSetting.style.display = this.value === 'searxng' ? '' : 'none';
    });

    // Personality toggle handlers
    personalityEnabled.addEventListener('change', function() {
      personalityTogText.textContent = this.checked ? 'Enabled' : 'Disabled';
    });
    dialectEnabled.addEventListener('change', function() {
      dialectTogText.textContent = this.checked ? 'Enabled' : 'Disabled';
    });
    stabilizerEnabled.addEventListener('change', function() {
      stabilizerTogText.textContent = this.checked ? 'Enabled' : 'Disabled';
    });

    // Save settings
    saveBtn.addEventListener('click', function() {
      statusEl.textContent = 'Saving...';
      statusEl.style.color = 'var(--text-muted)';

      var updates = [
        { key: 'ai.default_text_model', value: modelSelect.value },
        { key: 'ai.default_vision_model', value: visionSelect.value },
        { key: 'ai.enable_image', value: imageToggle.checked },
        { key: 'ai.default_image_engine', value: imageEngine.value },
        { key: 'ai.image.max_per_day_free.prod', value: parseInt(maxImagesProd.value, 10) },
        { key: 'ai.image.max_per_day_free.dev', value: parseInt(maxImagesDev.value, 10) },
        { key: 'rate_limit.chat.prod', value: parseInt(rateChatProd.value, 10) },
        { key: 'rate_limit.chat.dev', value: parseInt(rateChatDev.value, 10) },
        { key: 'rate_limit.image.prod', value: parseInt(rateImageProd.value, 10) },
        { key: 'rate_limit.image.dev', value: parseInt(rateImageDev.value, 10) },
        { key: 'typing.enabled', value: typingEnabled.checked },
        { key: 'typing.mode', value: typingMode.value },
        { key: 'typing.speed', value: parseInt(typingSpeed.value, 10) },
        { key: 'typing.adaptive_catchup', value: typingAdaptive.checked },
        // Web research
        { key: 'web_research.enabled', value: webEnabled.checked },
        { key: 'web_research.search_provider', value: webProvider.value },
        { key: 'web_research.searxng_url', value: webSearxUrl.value.trim() },
        { key: 'web_research.max_sources', value: parseInt(webMaxSources.value, 10) },
        { key: 'web_research.max_fetch', value: parseInt(webMaxFetch.value, 10) },
        { key: 'web_research.cache_ttl_minutes', value: parseInt(webCacheTtl.value, 10) },
        { key: 'web_research.timeout_seconds', value: parseInt(webTimeout.value, 10) },
        { key: 'web_research.allowed_domains', value: webAllowed.value.trim() },
        { key: 'web_research.blocked_domains', value: webBlocked.value.trim() },
        // Personality & routing
        { key: 'ai.personality_enabled', value: personalityEnabled.checked },
        { key: 'ai.dialect_mirroring', value: dialectEnabled.checked },
        { key: 'ai.smalltalk_stabilizer', value: stabilizerEnabled.checked },
        { key: 'ai.dialect_mirroring_level', value: dialectLevel.value },
        { key: 'ai.smalltalk_max_tokens', value: parseInt(smalltalkTokens.value, 10) },
        { key: 'ai.general_max_tokens', value: parseInt(generalTokens.value, 10) },
        { key: 'ai.task_max_tokens', value: parseInt(taskTokens.value, 10) },
        // Guest limits
        { key: 'guest.chat_per_day', value: parseInt(guestChatDay.value, 10) },
        { key: 'guest.doc_per_day', value: parseInt(guestDocDay.value, 10) },
        { key: 'guest.image_per_day', value: parseInt(guestImageDay.value, 10) },
        { key: 'guest.require_register_after_n', value: parseInt(guestRegisterN.value, 10) },
        // Document limits
        { key: 'limits.max_file_size_mb', value: parseInt(maxFileMb.value, 10) },
        { key: 'limits.max_pdf_pages_guest', value: parseInt(pdfPagesGuest.value, 10) },
        { key: 'limits.max_pdf_pages_registered', value: parseInt(pdfPagesRegistered.value, 10) },
      ];

      Promise.all(updates.map(function(u) {
        return fetch('/v1/admin/settings/' + encodeURIComponent(u.key), {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ value: u.value })
        }).then(function(r) { return r.json(); });
      }))
      .then(function(results) {
        var allOk = results.every(function(r) { return r.ok; });
        if (allOk) {
          statusEl.textContent = 'Saved!';
          statusEl.style.color = 'var(--green)';
        } else {
          var failed = [];
          results.forEach(function(r, i) {
            if (!r.ok) failed.push(updates[i].key + ': ' + (r.error || 'unknown'));
          });
          statusEl.textContent = 'Failed: ' + failed.join(', ');
          statusEl.style.color = 'var(--red)';
          console.warn('[admin] Settings that failed:', failed);
        }
        setTimeout(function() { statusEl.textContent = ''; }, 3000);
      })
      .catch(function() {
        statusEl.textContent = 'Save failed';
        statusEl.style.color = 'var(--red)';
        setTimeout(function() { statusEl.textContent = ''; }, 3000);
      });
    });
  })();
  </script>

  <!-- Users Panel Script -->
  <script>
  (function() {
    'use strict';

    var userTableBody = document.getElementById('user-table-body');
    var userSearch    = document.getElementById('user-search');
    var searchBtn     = document.getElementById('user-search-btn');
    var pagination    = document.getElementById('user-pagination');
    var currentPage   = 1;

    function escapeHtml(str) {
      var d = document.createElement('div');
      d.textContent = str || '';
      return d.innerHTML;
    }

    function formatDate(dateStr) {
      if (!dateStr) return '‚Äî';
      var d = new Date(dateStr);
      return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
    }

    function loadUserStats() {
      fetch('/v1/admin/users/stats')
        .then(function(r) { return r.json(); })
        .then(function(data) {
          var el = function(id) { return document.getElementById(id); };
          if (el('stat-total'))    el('stat-total').textContent    = data.total_users     || '0';
          if (el('stat-active'))   el('stat-active').textContent   = data.active_users    || '0';
          if (el('stat-verified')) el('stat-verified').textContent = data.verified_users   || '0';
          if (el('stat-7d'))       el('stat-7d').textContent       = data.new_last_7d     || '0';
          if (el('stat-30d'))      el('stat-30d').textContent      = data.new_last_30d    || '0';
          if (el('stat-google'))   el('stat-google').textContent   = (data.oauth_providers && data.oauth_providers.google)   || '0';
          if (el('stat-facebook')) el('stat-facebook').textContent = (data.oauth_providers && data.oauth_providers.facebook) || '0';
        })
        .catch(function() {});
    }

    function loadUsers(page, search) {
      currentPage = page || 1;
      var qs = '?page=' + currentPage + '&limit=25';
      if (search) qs += '&search=' + encodeURIComponent(search);

      userTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-dim);padding:24px;">Loading‚Ä¶</td></tr>';

      fetch('/v1/admin/users' + qs)
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (!data.users || data.users.length === 0) {
            userTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-dim);padding:24px;">No users found</td></tr>';
            pagination.innerHTML = '';
            return;
          }

          userTableBody.innerHTML = data.users.map(function(u) {
            // Avatar or initials
            var avatarHtml;
            if (u.avatar_url) {
              avatarHtml = '<img class="user-table__avatar" src="' + escapeHtml(u.avatar_url) + '" alt="">';
            } else {
              var initial = (u.name || u.email || '?').charAt(0).toUpperCase();
              avatarHtml = '<div class="user-table__initials">' + initial + '</div>';
            }

            // Providers
            var providers = '';
            if (u.oauth_providers && u.oauth_providers.length > 0) {
              providers = u.oauth_providers.map(function(p) {
                var cls = 'user-provider-badge user-provider-badge--' + p.provider;
                return '<span class="' + cls + '">' + p.provider + '</span>';
              }).join(' ');
            } else {
              providers = '<span class="user-provider-badge user-provider-badge--email">email</span>';
            }

            // Status
            var statusCls = u.is_active ? 'user-status-badge--active' : 'user-status-badge--inactive';
            var statusText = u.is_active ? 'Active' : 'Inactive';

            return '<tr>' +
              '<td><div class="user-table__user">' + avatarHtml + '<span class="user-table__name">' + escapeHtml(u.name || '‚Äî') + '</span></div></td>' +
              '<td>' + escapeHtml(u.email) + '</td>' +
              '<td>' + providers + '</td>' +
              '<td><span class="user-status-badge ' + statusCls + '">' + statusText + '</span></td>' +
              '<td>' + formatDate(u.created_at) + '</td>' +
              '</tr>';
          }).join('');

          // Pagination
          var p = data.pagination;
          if (p.totalPages > 1) {
            pagination.innerHTML =
              '<button class="user-pagination__btn" id="users-prev" ' + (p.page <= 1 ? 'disabled' : '') + '>‚Üê Prev</button>' +
              '<span class="user-pagination__info">Page ' + p.page + ' of ' + p.totalPages + ' (' + p.total + ' users)</span>' +
              '<button class="user-pagination__btn" id="users-next" ' + (p.page >= p.totalPages ? 'disabled' : '') + '>Next ‚Üí</button>';

            var prevBtn = document.getElementById('users-prev');
            var nextBtn = document.getElementById('users-next');
            if (prevBtn) prevBtn.addEventListener('click', function() { loadUsers(currentPage - 1, userSearch.value.trim()); });
            if (nextBtn) nextBtn.addEventListener('click', function() { loadUsers(currentPage + 1, userSearch.value.trim()); });
          } else {
            pagination.innerHTML = '<span class="user-pagination__info">' + p.total + ' user' + (p.total !== 1 ? 's' : '') + '</span>';
          }
        })
        .catch(function() {
          userTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--red);padding:24px;">Failed to load users</td></tr>';
        });
    }

    // Search handlers
    searchBtn.addEventListener('click', function() { loadUsers(1, userSearch.value.trim()); });
    userSearch.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') loadUsers(1, this.value.trim());
    });

    // Load when Users tab is activated
    var usersLoaded = false;
    var observer = new MutationObserver(function() {
      var panel = document.getElementById('panel-users');
      if (panel && panel.classList.contains('active') && !usersLoaded) {
        usersLoaded = true;
        loadUserStats();
        loadUsers(1);
      }
    });

    var panel = document.getElementById('panel-users');
    if (panel) {
      observer.observe(panel, { attributes: true, attributeFilter: ['class'] });
      // Also check if already active
      if (panel.classList.contains('active')) {
        loadUserStats();
        loadUsers(1);
        usersLoaded = true;
      }
    }
  })();
  </script>

  <!-- ‚îÄ‚îÄ Reporting Tab JS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <script>
  (function() {
    'use strict';

    var rptDays = 7;
    var rptLoaded = false;

    /* ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    function fmtNum(n) {
      if (n === null || n === undefined || n === '‚Äî') return '‚Äî';
      n = Number(n);
      if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
      if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
      return String(n);
    }

    function fmtDate(d) {
      if (!d) return '‚Äî';
      var dt = new Date(d);
      return dt.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
    }

    function fmtDateTime(d) {
      if (!d) return '‚Äî';
      var dt = new Date(d);
      return dt.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });
    }

    function escapeHtml(s) {
      var d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }

    /* ‚îÄ‚îÄ Range buttons ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    var rangeButtons = document.querySelectorAll('.rpt-range');
    rangeButtons.forEach(function(btn) {
      btn.addEventListener('click', function() {
        rangeButtons.forEach(function(b) { b.classList.remove('active'); });
        btn.classList.add('active');
        rptDays = parseInt(btn.dataset.days, 10);
        loadAllReporting();
      });
    });

    document.getElementById('rpt-refresh').addEventListener('click', function() {
      loadAllReporting();
    });

    /* ‚îÄ‚îÄ Load all reporting data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    function loadAllReporting() {
      loadSummary();
      loadDaily();
      loadBreakdown();
      loadTopVisitors();
      loadGuestLimits();
    }

    /* ‚îÄ‚îÄ Summary KPIs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    function loadSummary() {
      fetch('/v1/admin/reporting/summary?days=' + rptDays)
        .then(function(r) { return r.json(); })
        .then(function(d) {
          document.getElementById('rpt-total-events').textContent = fmtNum(d.total_events);
          document.getElementById('rpt-total-chats').textContent = fmtNum(d.total_chats);
          document.getElementById('rpt-total-images').textContent = fmtNum(d.total_images);
          document.getElementById('rpt-unique-visitors').textContent = fmtNum(d.unique_visitors);
          document.getElementById('rpt-registered-users').textContent = fmtNum(d.registered_users);
          document.getElementById('rpt-guest-events').textContent = fmtNum(d.guest_events);
          var totalTokens = (Number(d.total_tokens_in) || 0) + (Number(d.total_tokens_out) || 0);
          document.getElementById('rpt-tokens-total').textContent = fmtNum(totalTokens);

          document.getElementById('rpt-today-chats').textContent = d.chats_today;
          document.getElementById('rpt-today-images').textContent = d.images_today;
          document.getElementById('rpt-today-visitors').textContent = d.visitors_today;
        })
        .catch(function() {
          document.getElementById('rpt-total-events').textContent = 'Err';
        });
    }

    /* ‚îÄ‚îÄ Daily Chart ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    function loadDaily() {
      fetch('/v1/admin/reporting/daily?days=' + rptDays)
        .then(function(r) { return r.json(); })
        .then(function(d) {
          var chart = document.getElementById('rpt-chart');
          var labels = document.getElementById('rpt-chart-labels');
          var series = d.series || [];

          if (series.length === 0) {
            chart.innerHTML = '<span style="color:var(--text-dim);font-size:.8rem;padding:16px;">No data yet</span>';
            labels.innerHTML = '';
            return;
          }

          var maxVal = 1;
          series.forEach(function(s) {
            var t = (s.chats || 0) + (s.images || 0);
            if (t > maxVal) maxVal = t;
          });

          var barWidth = Math.max(8, Math.floor(chart.offsetWidth / series.length) - 3);

          chart.innerHTML = series.map(function(s) {
            var chats = s.chats || 0;
            var images = s.images || 0;
            var total = chats + images;
            var chatH = Math.max(1, Math.round((chats / maxVal) * 160));
            var imgH = Math.round((images / maxVal) * 160);
            return '<div style="display:flex;flex-direction:column;align-items:center;gap:0;min-width:' + barWidth + 'px;" title="' + fmtDate(s.day) + ': ' + chats + ' chats, ' + images + ' images">' +
              (imgH > 0 ? '<div style="width:100%;height:' + imgH + 'px;background:#f59e0b;border-radius:2px 2px 0 0;"></div>' : '') +
              '<div style="width:100%;height:' + chatH + 'px;background:var(--accent);border-radius:' + (imgH > 0 ? '0' : '2px 2px') + ' 0 0;"></div>' +
              '<span style="font-size:.55rem;color:var(--text-dim);margin-top:2px;">' + (total > 0 ? total : '') + '</span>' +
              '</div>';
          }).join('');

          labels.innerHTML = series.map(function(s) {
            var dt = new Date(s.day);
            var lbl = dt.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
            return '<span style="min-width:' + barWidth + 'px;text-align:center;">' + (series.length <= 14 ? lbl : '') + '</span>';
          }).join('');
        })
        .catch(function() {
          document.getElementById('rpt-chart').innerHTML = '<span style="color:var(--red);font-size:.8rem;">Failed to load chart</span>';
        });
    }

    /* ‚îÄ‚îÄ Breakdown ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    function loadBreakdown() {
      fetch('/v1/admin/reporting/breakdown?days=' + rptDays)
        .then(function(r) { return r.json(); })
        .then(function(d) {
          // By mode
          var modeEl = document.getElementById('rpt-by-mode');
          if (d.by_mode && d.by_mode.length > 0) {
            modeEl.innerHTML = d.by_mode.map(function(m) {
              return '<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--border);">' +
                '<span>' + escapeHtml((m.event_type || '?') + ' ‚Üí ' + (m.mode || 'n/a')) + '</span>' +
                '<strong>' + m.count + '</strong></div>';
            }).join('');
          } else {
            modeEl.innerHTML = '<span style="color:var(--text-dim);">No data</span>';
          }

          // By model
          var modelEl = document.getElementById('rpt-by-model');
          if (d.by_model && d.by_model.length > 0) {
            modelEl.innerHTML = d.by_model.map(function(m) {
              return '<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--border);">' +
                '<span>' + escapeHtml(m.model) + '</span>' +
                '<strong>' + m.count + '</strong></div>';
            }).join('');
          } else {
            modelEl.innerHTML = '<span style="color:var(--text-dim);">No data</span>';
          }

          // Error rate
          var e = d.errors || {};
          var errRate = e.total > 0 ? ((e.error_count / e.total) * 100).toFixed(1) + '%' : '0%';
          document.getElementById('rpt-error-rate').textContent = errRate + ' (' + (e.error_count || 0) + '/' + (e.total || 0) + ')';
        })
        .catch(function() {
          document.getElementById('rpt-by-mode').innerHTML = '<span style="color:var(--red);">Failed</span>';
        });
    }

    /* ‚îÄ‚îÄ Top Visitors ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    function loadTopVisitors() {
      fetch('/v1/admin/reporting/top-visitors?days=' + rptDays)
        .then(function(r) { return r.json(); })
        .then(function(d) {
          var tbody = document.getElementById('rpt-visitors-body');
          var visitors = d.visitors || [];
          if (visitors.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text-dim);padding:24px;">No activity yet</td></tr>';
            return;
          }
          tbody.innerHTML = visitors.map(function(v) {
            var vid = v.visitor_id ? v.visitor_id.substring(0, 8) + '‚Ä¶' : '‚Äî';
            var typeBadge = v.user_id
              ? '<span class="badge badge--ok" style="font-size:.6rem;"><span class="badge__dot"></span>Registered</span>'
              : '<span class="badge badge--access" style="font-size:.6rem;">Guest</span>';
            return '<tr>' +
              '<td style="font-family:var(--font-mono);font-size:.72rem;">' + escapeHtml(vid) + '</td>' +
              '<td>' + typeBadge + '</td>' +
              '<td style="text-align:center;">' + (v.chats || 0) + '</td>' +
              '<td style="text-align:center;">' + (v.images || 0) + '</td>' +
              '<td style="text-align:center;font-weight:600;">' + (v.total_events || 0) + '</td>' +
              '<td style="font-size:.72rem;">' + fmtDateTime(v.first_seen) + '</td>' +
              '<td style="font-size:.72rem;">' + fmtDateTime(v.last_seen) + '</td>' +
              '</tr>';
          }).join('');
        })
        .catch(function() {
          document.getElementById('rpt-visitors-body').innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--red);padding:24px;">Failed to load</td></tr>';
        });
    }

    /* ‚îÄ‚îÄ Guest Limits ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    function loadGuestLimits() {
      fetch('/v1/admin/reporting/guest-limits')
        .then(function(r) { return r.json(); })
        .then(function(d) {
          var s = d.settings || {};
          var chatHour = document.getElementById('rpt-guest-chat-hour');
          var imagesDay = document.getElementById('rpt-guest-images-day');
          var gateChats = document.getElementById('rpt-gate-chats');
          var gateImages = document.getElementById('rpt-gate-images');

          if (s['guest.chat_per_hour'] !== undefined) chatHour.value = s['guest.chat_per_hour'];
          if (s['guest.images_per_day'] !== undefined) imagesDay.value = s['guest.images_per_day'];
          if (s['guest.soft_gate_after_chats'] !== undefined) gateChats.value = s['guest.soft_gate_after_chats'];
          if (s['guest.soft_gate_after_images'] !== undefined) gateImages.value = s['guest.soft_gate_after_images'];

          document.getElementById('rpt-active-guests').textContent = d.active_guests || 0;
          document.getElementById('rpt-guest-chats-1h').textContent = d.guest_chats_last_hour || 0;
          document.getElementById('rpt-guest-images-today').textContent = d.guest_images_today || 0;
        })
        .catch(function() {});
    }

    /* ‚îÄ‚îÄ Save guest limits ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    document.getElementById('rpt-save-guest').addEventListener('click', function() {
      var status = document.getElementById('rpt-guest-status');
      status.textContent = 'Saving‚Ä¶';
      status.style.color = 'var(--text-muted)';

      var updates = [
        { key: 'guest.chat_per_hour', value: parseInt(document.getElementById('rpt-guest-chat-hour').value, 10) },
        { key: 'guest.images_per_day', value: parseInt(document.getElementById('rpt-guest-images-day').value, 10) },
        { key: 'guest.soft_gate_after_chats', value: parseInt(document.getElementById('rpt-gate-chats').value, 10) },
        { key: 'guest.soft_gate_after_images', value: parseInt(document.getElementById('rpt-gate-images').value, 10) },
      ];

      Promise.all(updates.map(function(u) {
        return fetch('/v1/admin/settings/' + u.key, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ value: u.value }),
        });
      }))
      .then(function() {
        status.textContent = '‚úì Saved';
        status.style.color = 'var(--green, #22c55e)';
        setTimeout(function() { status.textContent = ''; }, 2000);
      })
      .catch(function() {
        status.textContent = '‚úó Failed';
        status.style.color = 'var(--red, #ef4444)';
      });
    });

    /* ‚îÄ‚îÄ Load on tab activate ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    var rptPanel = document.getElementById('panel-reporting');
    if (rptPanel) {
      var rptObserver = new MutationObserver(function() {
        if (rptPanel.classList.contains('active') && !rptLoaded) {
          rptLoaded = true;
          loadAllReporting();
        }
      });
      rptObserver.observe(rptPanel, { attributes: true, attributeFilter: ['class'] });
      if (rptPanel.classList.contains('active')) {
        rptLoaded = true;
        loadAllReporting();
      }
    }

    // If range changes, allow reload
    rangeButtons.forEach(function(btn) {
      btn.addEventListener('click', function() { rptLoaded = true; });
    });
    document.getElementById('rpt-refresh').addEventListener('click', function() { rptLoaded = true; });

  })();
  </script>
</body>
</html>
