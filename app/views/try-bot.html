<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Try AI Chat â€” Getouch</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <div class="bg-mesh"></div>

  <div class="try-layout">
    <!-- â”€â”€â”€ Top Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <nav class="try-nav">
      <a href="/" class="try-nav__back">â† Back</a>
      <div class="try-nav__title">
        <span class="try-nav__icon">ğŸ¤–</span>
        Bot / AI API
      </div>
      <div class="try-nav__status">
        <span class="badge badge--checking" data-service="bot">
          <span class="badge__dot badge__dot--pulse"></span>Checking
        </span>
      </div>
    </nav>

    <!-- â”€â”€â”€ Chat Area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="chat">
      <div class="chat__messages" id="chat-messages">
        <!-- Welcome message -->
        <div class="chat__msg chat__msg--bot">
          <div class="chat__avatar">ğŸ¤–</div>
          <div class="chat__bubble">
            <div class="chat__bubble-header">
              <span class="chat__sender">Getouch AI</span>
              <span class="chat__model">qwen2.5 Â· Ollama</span>
            </div>
            <p>Hello! I'm the Getouch AI assistant powered by <strong>Ollama qwen2.5</strong> running on-premises.</p>
            <p style="margin-top:8px">Ask me anything â€” I can help with general questions, coding, analysis, and more. All processing happens on our own servers, so your data stays private.</p>
          </div>
        </div>

        <!-- Suggestion chips -->
        <div class="chat__suggestions" id="chat-suggestions">
          <button class="chip" data-msg="What can you help me with?">What can you help me with?</button>
          <button class="chip" data-msg="Write a Python function to sort a list">Write a Python function</button>
          <button class="chip" data-msg="Explain how WhatsApp automation works">WhatsApp automation</button>
          <button class="chip" data-msg="What AI model are you running?">What model are you?</button>
        </div>
      </div>

      <!-- â”€â”€â”€ Input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div class="chat__input-area">
        <div class="chat__input-wrap">
          <textarea class="chat__input" id="chat-input" placeholder="Type a message..." rows="1"></textarea>
          <button class="chat__send" id="chat-send" title="Send message">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
            </svg>
          </button>
        </div>
        <p class="chat__disclaimer">AI responses are generated by Ollama qwen2.5. This is a demo â€” responses may be limited.</p>
      </div>
    </div>
  </div>

  <script>
  (function() {
    'use strict';

    var messages   = document.getElementById('chat-messages');
    var input      = document.getElementById('chat-input');
    var sendBtn    = document.getElementById('chat-send');
    var suggestions = document.getElementById('chat-suggestions');
    var isLoading  = false;

    /* â”€â”€ Auto-resize textarea â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    input.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });

    /* â”€â”€ Send on Enter (Shift+Enter for newline) â”€â”€â”€â”€â”€â”€â”€ */
    input.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    sendBtn.addEventListener('click', sendMessage);

    /* â”€â”€ Suggestion chips â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    suggestions.addEventListener('click', function(e) {
      var chip = e.target.closest('.chip');
      if (chip) {
        input.value = chip.dataset.msg;
        sendMessage();
      }
    });

    function scrollToBottom() {
      messages.scrollTop = messages.scrollHeight;
    }

    function addMessage(role, html) {
      var div = document.createElement('div');
      div.className = 'chat__msg chat__msg--' + role;

      if (role === 'user') {
        div.innerHTML =
          '<div class="chat__bubble chat__bubble--user">' +
          '<p>' + escapeHtml(html) + '</p>' +
          '</div>' +
          '<div class="chat__avatar chat__avatar--user">You</div>';
      } else {
        div.innerHTML =
          '<div class="chat__avatar">ğŸ¤–</div>' +
          '<div class="chat__bubble">' +
          '<div class="chat__bubble-header">' +
          '<span class="chat__sender">Getouch AI</span>' +
          '</div>' +
          '<p>' + html + '</p>' +
          '</div>';
      }

      messages.appendChild(div);
      scrollToBottom();
      return div;
    }

    function addTypingIndicator() {
      var div = document.createElement('div');
      div.className = 'chat__msg chat__msg--bot';
      div.id = 'typing-indicator';
      div.innerHTML =
        '<div class="chat__avatar">ğŸ¤–</div>' +
        '<div class="chat__bubble chat__bubble--typing">' +
        '<div class="typing-dots"><span></span><span></span><span></span></div>' +
        '</div>';
      messages.appendChild(div);
      scrollToBottom();
    }

    function removeTypingIndicator() {
      var el = document.getElementById('typing-indicator');
      if (el) el.remove();
    }

    function escapeHtml(text) {
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function sendMessage() {
      var text = input.value.trim();
      if (!text || isLoading) return;

      // Hide suggestions after first message
      if (suggestions) {
        suggestions.style.display = 'none';
      }

      addMessage('user', text);
      input.value = '';
      input.style.height = 'auto';
      isLoading = true;
      sendBtn.disabled = true;

      addTypingIndicator();

      fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: text })
      })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        removeTypingIndicator();
        if (data.error) {
          addMessage('bot', '<span style="color:var(--red)">' + escapeHtml(data.error) + '</span><br><span style="color:var(--text-dim);font-size:.8rem">The Bot/AI service may be offline. Check the admin dashboard for status.</span>');
        } else {
          addMessage('bot', formatResponse(data.reply || data.message || 'No response'));
        }
      })
      .catch(function() {
        removeTypingIndicator();
        addMessage('bot', '<span style="color:var(--red)">Could not reach the AI service.</span><br><span style="color:var(--text-dim);font-size:.8rem">The service may be offline or starting up. Try again in a moment.</span>');
      })
      .finally(function() {
        isLoading = false;
        sendBtn.disabled = false;
        input.focus();
      });
    }

    function formatResponse(text) {
      // Basic markdown-like formatting
      return escapeHtml(text)
        .replace(/```([\s\S]*?)```/g, '<pre class="chat__code">$1</pre>')
        .replace(/`([^`]+)`/g, '<code class="chat__inline-code">$1</code>')
        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br>');
    }

    /* â”€â”€ Update status badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    fetch('/api/status')
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (data.services && data.services.bot) {
          var badges = document.querySelectorAll('[data-service="bot"]');
          badges.forEach(function(el) {
            if (data.services.bot.status === 'ok') {
              el.className = 'badge badge--ok';
              el.innerHTML = '<span class="badge__dot"></span>Online';
            } else {
              el.className = 'badge badge--offline';
              el.innerHTML = '<span class="badge__dot"></span>Offline';
            }
          });
        }
      })
      .catch(function() {});
  })();
  </script>
</body>
</html>
