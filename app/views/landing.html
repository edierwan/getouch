<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Getouch â€” Intelligent engagement platform powered by on-premises AI">
  <title>Getouch Platform</title>
  <link rel="stylesheet" href="/css/styles.css?v={{VERSION}}">
</head>
<body>
  <div class="bg-mesh"></div>

  <div class="container">
    <!-- â”€â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <nav class="nav">
      <a href="/" class="nav__logo" id="nav-logo" style="text-decoration:none;">ge<span>touch</span></a>
      <ul class="nav__links" id="nav-links">
        <li id="nav-login"><a href="/auth/login" class="btn btn--ghost" style="padding: 6px 16px; font-size: 0.8125rem;">Login</a></li>
        <li id="nav-register"><a href="/auth/register" class="btn btn--primary" style="padding: 6px 16px; font-size: 0.8125rem;">Get Started</a></li>
        <li id="nav-avatar" style="display:none;">
          <a href="/dashboard" class="nav__user-avatar" title="Dashboard">
            <img id="nav-avatar-img" src="" alt="Profile" style="width:32px;height:32px;border-radius:50%;border:2px solid var(--accent);object-fit:cover;">
          </a>
        </li>
      </ul>
    </nav>

    <!-- â”€â”€â”€ Chat-First Interface â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <section class="hero hero--chat">
      <!-- Welcome state: shown before first message -->
      <div class="landing-welcome" id="landing-welcome">
        <div class="hero__chat-icon" style="display:flex;">
          <svg width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
            <path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <h1 class="hero__title" style="font-size: clamp(1.5rem, 3.5vw, 2.25rem);">
          Hi, I'm <span class="gradient-text">Getouch AI</span>
        </h1>
        <p class="hero__subtitle" style="margin-bottom: 16px; font-size: .9rem;">
          Ask me anything about our services â€” WhatsApp automation, AI
          chatbot API, database tools, or any general question.
        </p>

        <!-- Suggestion Chips -->
        <div class="landing-suggestions" id="landing-suggestions">
          <div class="landing-suggestions__chips">
            <button class="chip chip--landing" data-msg="What services do you offer?">ðŸ’¬ What services do you offer?</button>
            <button class="chip chip--landing" data-msg="Tell me about WhatsApp Gateway">ðŸ“± WhatsApp Gateway</button>
            <button class="chip chip--landing" data-msg="How does the AI Bot work?">ðŸ“¦ How does the AI Bot work?</button>
            <button class="chip chip--landing" data-msg="Show me the REST API">âš¡ REST API</button>
            <button class="chip chip--landing" data-msg="What are AI + DB tools?">ðŸ’» AI + DB tools</button>
            <button class="chip chip--landing" data-msg="How do I get started?">ðŸš€ Get started</button>
          </div>
        </div>
      </div>

      <!-- Chat Messages Area (shown from first message) -->
      <div class="landing-chat" id="landing-chat" style="display:none;">
        <div class="landing-chat__messages" id="landing-messages"></div>
      </div>

      <!-- Image Result Area (for image mode) -->
      <div class="landing-image-result" id="landing-image-result" style="display:none;">
        <div class="landing-image-result__inner" id="image-result-inner"></div>
      </div>
    </section>

    <!-- â”€â”€â”€ Input Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="landing-input-bar">
      <div class="landing-input-bar__inner">
        <input type="text"
          class="landing-input-bar__input"
          id="landing-input"
          placeholder="Ask about our services or anything else..."
          autocomplete="off"
          maxlength="4000">
        <div class="landing-input-bar__bottom">
          <!-- Mode Selector: minimal + button with popover -->
          <div class="mode-sel" id="mode-dropdown">
            <button class="mode-sel__btn" id="mode-trigger" type="button"
                    title="Switch mode" aria-haspopup="menu" aria-expanded="false">
              <svg class="mode-sel__icon" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
              <span class="mode-sel__label" id="mode-text">Getouch AI</span>
            </button>
            <div class="mode-sel__popover" id="mode-menu" role="menu">
              <button class="mode-sel__option mode-sel__option--active" data-mode="text" type="button"
                      role="menuitemradio" aria-checked="true" tabindex="0">
                <span class="mode-sel__opt-icon">ðŸ’¬</span>
                <span class="mode-sel__opt-label">Getouch AI</span>
                <svg class="mode-sel__check" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"/></svg>
              </button>
              <button class="mode-sel__option" data-mode="image" type="button"
                      role="menuitemradio" aria-checked="false" tabindex="-1">
                <span class="mode-sel__opt-icon">ðŸŽ¨</span>
                <span class="mode-sel__opt-label">Getouch Image</span>
                <svg class="mode-sel__check" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"/></svg>
              </button>
            </div>
          </div>
          <!-- Typing Pace Settings -->
          <div class="typing-gear" id="typing-gear">
            <button class="typing-gear__btn" id="typing-gear-btn" type="button"
                    title="Typing effect settings" aria-haspopup="dialog" aria-expanded="false">
              <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.573-1.066z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
            </button>
            <div class="typing-gear__popover" id="typing-gear-menu">
              <div class="typing-gear__title">Typing Effect</div>
              <label class="typing-gear__row">
                <span class="typing-gear__label">Enable typewriter</span>
                <span class="ai-toggle ai-toggle--sm">
                  <input type="checkbox" id="tw-enabled">
                  <span class="ai-toggle__slider"></span>
                </span>
              </label>
              <label class="typing-gear__row" id="tw-mode-row">
                <span class="typing-gear__label">Chunk mode</span>
                <select class="typing-gear__select" id="tw-mode">
                  <option value="word">Word</option>
                  <option value="char">Character</option>
                </select>
              </label>
              <div class="typing-gear__row" id="tw-speed-row">
                <span class="typing-gear__label">Speed <span id="tw-speed-val">35</span>ms</span>
                <input type="range" class="typing-gear__range" id="tw-speed" min="5" max="200" step="5" value="35">
              </div>
              <label class="typing-gear__row" id="tw-adaptive-row">
                <span class="typing-gear__label">Adaptive catch-up</span>
                <span class="ai-toggle ai-toggle--sm">
                  <input type="checkbox" id="tw-adaptive" checked>
                  <span class="ai-toggle__slider"></span>
                </span>
              </label>
            </div>
          </div>
          <!-- Send Button -->
          <button class="landing-input-bar__send" id="landing-send" title="Send">
            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
              <path d="M5 12h14M12 5l7 7-7 7"/>
            </svg>
          </button>
        </div>
      </div>
      <div class="landing-input-bar__footer">
        Powered by <a href="/">Getouch AI</a> Â· On-premises Â· Your data stays private Â·
        <a href="/admin/">Admin</a>
      </div>
      <!-- Image Quota Badge (shown in image mode) -->
      <div class="landing-quota" id="landing-quota" style="display:none;">
        <span id="quota-text"></span>
      </div>
    </div>
  </div>

  <script>
  (function() {
    'use strict';

    /* â”€â”€ Elements â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    var input       = document.getElementById('landing-input');
    var sendBtn     = document.getElementById('landing-send');
    var modeTrigger = document.getElementById('mode-trigger');
    var modeMenu    = document.getElementById('mode-menu');
    var modeDropdown= document.getElementById('mode-dropdown');
    var modeLabel   = document.getElementById('mode-text');
    var suggestions = document.getElementById('landing-suggestions');
    var welcome     = document.getElementById('landing-welcome');
    var heroChat    = document.querySelector('.hero--chat');
    var chatArea    = document.getElementById('landing-chat');
    var messages    = document.getElementById('landing-messages');
    var imageResult = document.getElementById('landing-image-result');
    var imageInner  = document.getElementById('image-result-inner');
    var quotaBadge  = document.getElementById('landing-quota');
    var quotaText   = document.getElementById('quota-text');

    var isStreaming = false;
    var currentMode = localStorage.getItem('getouch_mode') || 'text';
    var abortCtrl   = null;

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       Typewriter / Typing Effect Engine
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    var TYPING_DEFAULTS = {
      enabled: true,
      mode: 'word',       // 'char' | 'word'
      speed: 35,          // ms per char (or per word when mode=word â†’ speedÃ—3)
      startDelay: 200,    // ms before first character
      adaptiveCatchUp: true
    };

    function loadTypingSettings() {
      try {
        var raw = localStorage.getItem('getouch_chat_typing');
        if (raw) {
          var parsed = JSON.parse(raw);
          return {
            enabled:          typeof parsed.enabled === 'boolean' ? parsed.enabled : TYPING_DEFAULTS.enabled,
            mode:             parsed.mode === 'char' || parsed.mode === 'word' ? parsed.mode : TYPING_DEFAULTS.mode,
            speed:            typeof parsed.speed === 'number' ? Math.max(5, Math.min(200, parsed.speed)) : TYPING_DEFAULTS.speed,
            startDelay:       typeof parsed.startDelay === 'number' ? parsed.startDelay : TYPING_DEFAULTS.startDelay,
            adaptiveCatchUp:  typeof parsed.adaptiveCatchUp === 'boolean' ? parsed.adaptiveCatchUp : TYPING_DEFAULTS.adaptiveCatchUp
          };
        }
      } catch(e) {}
      return Object.assign({}, TYPING_DEFAULTS);
    }

    function saveTypingSettings(settings) {
      try { localStorage.setItem('getouch_chat_typing', JSON.stringify(settings)); } catch(e) {}
    }

    var typingSettings = loadTypingSettings();

    // Load server-side typing defaults (admin-configured) and merge with localStorage
    (function loadServerTypingSettings() {
      fetch('/v1/admin/settings')
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (!data.settings) return;
          var s = data.settings;
          var hasLocal = !!localStorage.getItem('getouch_chat_typing');
          // Server settings act as defaults; localStorage overrides
          if (!hasLocal) {
            if (s['typing.enabled'] !== undefined) typingSettings.enabled = !!s['typing.enabled'];
            if (s['typing.mode']) typingSettings.mode = s['typing.mode'];
            if (s['typing.speed'] !== undefined) typingSettings.speed = s['typing.speed'];
            if (s['typing.adaptive_catchup'] !== undefined) typingSettings.adaptiveCatchUp = !!s['typing.adaptive_catchup'];
            syncTypingUI();
          }
        })
        .catch(function() {});
    })();

    /**
     * Creates a typewriter renderer for one message bubble.
     *
     *   var tw = createTypewriter(contentEl, cursorEl, scrollFn);
     *   tw.push(delta);       // feed a token chunk
     *   tw.finish();          // stream ended â€” flush remaining
     *   tw.cancel();          // abort rendering (new prompt sent)
     *   tw.isIdle();          // true when buffer is empty & done
     */
    function createTypewriter(contentEl, cursorEl, scrollFn) {
      var buffer         = '';      // characters not yet rendered
      var rendered       = '';      // full rendered text so far
      var timer          = null;
      var streamDone     = false;
      var cancelled      = false;
      var started        = false;

      function effectiveDelay() {
        var base = typingSettings.speed;
        if (typingSettings.mode === 'word') base = base * 2.5;
        // Adaptive catch-up: when buffer > 80 chars, speed up proportionally
        if (typingSettings.adaptiveCatchUp && buffer.length > 80) {
          var factor = Math.min(buffer.length / 80, 8);
          base = Math.max(base / factor, 3);
        }
        return base;
      }

      function nextChunk() {
        if (typingSettings.mode === 'word') {
          // Emit next word (up to and including trailing whitespace)
          var m = buffer.match(/^\S*\s*/);
          return m ? m[0] : buffer.charAt(0);
        }
        return buffer.charAt(0);
      }

      function tick() {
        if (cancelled) return;

        if (buffer.length === 0) {
          if (streamDone) {
            // All done
            cursorEl.style.display = 'none';
            timer = null;
            return;
          }
          // Waiting for more tokens
          timer = setTimeout(tick, 50);
          return;
        }

        var chunk = nextChunk();
        buffer = buffer.slice(chunk.length);
        rendered += chunk;
        contentEl.innerHTML = formatMarkdown(rendered);
        scrollFn();

        timer = setTimeout(tick, effectiveDelay());
      }

      return {
        push: function(delta) {
          if (cancelled) return;
          buffer += delta;
          if (!started) {
            started = true;
            timer = setTimeout(tick, typingSettings.startDelay);
          }
        },
        finish: function() {
          streamDone = true;
          // If typewriter is disabled or was cancelled, flush immediately
          if (!typingSettings.enabled || cancelled) {
            this.flush();
          }
        },
        flush: function() {
          if (timer) { clearTimeout(timer); timer = null; }
          rendered += buffer;
          buffer = '';
          contentEl.innerHTML = formatMarkdown(rendered);
          cursorEl.style.display = 'none';
          scrollFn();
        },
        cancel: function() {
          cancelled = true;
          if (timer) { clearTimeout(timer); timer = null; }
        },
        isIdle: function() {
          return buffer.length === 0 && streamDone;
        },
        getFullText: function() {
          return rendered + buffer;
        }
      };
    }

    /* â”€â”€ Restore saved mode on load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    (function restoreMode() {
      if (currentMode === 'image') {
        var imgItem = modeMenu.querySelector('[data-mode="image"]');
        var txtItem = modeMenu.querySelector('[data-mode="text"]');
        if (imgItem && txtItem) {
          txtItem.classList.remove('mode-sel__option--active');
          txtItem.setAttribute('aria-checked', 'false');
          txtItem.tabIndex = -1;
          imgItem.classList.add('mode-sel__option--active');
          imgItem.setAttribute('aria-checked', 'true');
          imgItem.tabIndex = 0;
          modeLabel.textContent = 'Getouch Image';
          input.placeholder = 'Describe the image you want to generate...';
          input.maxLength = 1000;
          quotaBadge.style.display = '';
        }
      }
    })();

    /* â”€â”€ Popover open / close â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function openMenu() {
      modeDropdown.classList.add('mode-sel--open');
      modeTrigger.setAttribute('aria-expanded', 'true');
      var active = modeMenu.querySelector('.mode-sel__option--active');
      if (active) active.focus();
    }
    function closeMenu() {
      modeDropdown.classList.remove('mode-sel--open');
      modeTrigger.setAttribute('aria-expanded', 'false');
    }

    modeTrigger.addEventListener('click', function(e) {
      e.stopPropagation();
      modeDropdown.classList.contains('mode-sel--open') ? closeMenu() : openMenu();
    });
    modeTrigger.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openMenu(); }
    });
    document.addEventListener('click', function(e) {
      if (!modeDropdown.contains(e.target)) closeMenu();
    });
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && modeDropdown.classList.contains('mode-sel--open')) {
        closeMenu(); modeTrigger.focus();
      }
    });
    modeMenu.addEventListener('keydown', function(e) {
      var items = Array.from(modeMenu.querySelectorAll('.mode-sel__option'));
      var idx = items.indexOf(document.activeElement);
      if (e.key === 'ArrowDown') { e.preventDefault(); items[(idx+1)%items.length].focus(); }
      else if (e.key === 'ArrowUp') { e.preventDefault(); items[(idx-1+items.length)%items.length].focus(); }
      else if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); if (document.activeElement.dataset.mode) document.activeElement.click(); }
    });

    /* â”€â”€ Mode selection handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function selectMode(item) {
      currentMode = item.dataset.mode;
      modeMenu.querySelectorAll('.mode-sel__option').forEach(function(el) {
        el.classList.remove('mode-sel__option--active');
        el.setAttribute('aria-checked', 'false');
        el.tabIndex = -1;
      });
      item.classList.add('mode-sel__option--active');
      item.setAttribute('aria-checked', 'true');
      item.tabIndex = 0;
      modeLabel.textContent = item.querySelector('.mode-sel__opt-label').textContent;
      closeMenu();
      try { localStorage.setItem('getouch_mode', currentMode); } catch(e) {}

      if (currentMode === 'image') {
        input.placeholder = 'Describe the image you want to generate...';
        input.maxLength = 1000;
        quotaBadge.style.display = '';
        loadQuota();
      } else {
        input.placeholder = 'Ask about our services or anything else...';
        input.maxLength = 4000;
        quotaBadge.style.display = 'none';
      }
      input.focus();
    }
    modeMenu.querySelectorAll('.mode-sel__option').forEach(function(item) {
      item.addEventListener('click', function() { selectMode(this); });
    });

    /* â”€â”€ Quota loader â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function loadQuota() {
      fetch('/v1/image/quota')
        .then(function(r) { return r.json(); })
        .then(function(d) {
          quotaText.textContent = d.remaining + '/' + d.limit + ' images remaining today';
          quotaBadge.style.display = '';
        })
        .catch(function() {
          quotaText.textContent = 'Quota unavailable';
        });
    }

    /* â”€â”€ Send on Enter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    input.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    });
    sendBtn.addEventListener('click', send);

    /* â”€â”€ Suggestion chips â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    document.querySelectorAll('.chip--landing').forEach(function(chip) {
      chip.addEventListener('click', function() {
        input.value = this.dataset.msg;
        send();
      });
    });

    /* â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function escapeHtml(text) {
      var d = document.createElement('div');
      d.textContent = text;
      return d.innerHTML;
    }

    function formatMarkdown(text) {
      return escapeHtml(text)
        .replace(/```([\s\S]*?)```/g, '<pre class="chat__code">$1</pre>')
        .replace(/`([^`]+)`/g, '<code class="chat__inline-code">$1</code>')
        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br>');
    }

    function scrollChat() {
      messages.scrollTop = messages.scrollHeight;
    }

    /* â”€â”€ Main send function â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function send() {
      var text = input.value.trim();
      if (!text || isStreaming) return;

      // Hide welcome section, switch to chat-only layout
      if (welcome) {
        welcome.style.display = 'none';
      }
      if (heroChat) {
        heroChat.classList.add('is-chatting');
      }

      if (currentMode === 'image') {
        sendImage(text);
      } else {
        sendChat(text);
      }

      input.value = '';
    }

    /* â”€â”€ Active typewriter instance (for cancel on new prompt) â”€â”€ */
    var activeTypewriter = null;

    /* â”€â”€ Text Chat with SSE Streaming + Typewriter â”€â”€â”€â”€â”€â”€â”€ */
    function sendChat(text) {
      chatArea.style.display = '';
      imageResult.style.display = 'none';

      // Cancel any active typewriter (user sent new prompt)
      if (activeTypewriter) {
        activeTypewriter.cancel();
        activeTypewriter = null;
      }

      // Add user message
      var userDiv = document.createElement('div');
      userDiv.className = 'lc-msg lc-msg--user';
      userDiv.innerHTML = '<div class="lc-msg__bubble lc-msg__bubble--user">' + escapeHtml(text) + '</div>';
      messages.appendChild(userDiv);
      scrollChat();

      // Add bot message container
      var botDiv = document.createElement('div');
      botDiv.className = 'lc-msg lc-msg--bot';
      botDiv.innerHTML =
        '<div class="lc-msg__avatar">ðŸ’¬</div>' +
        '<div class="lc-msg__bubble">' +
          '<span class="lc-msg__thinking">Thinkingâ€¦</span>' +
          '<span class="lc-msg__content"></span>' +
          '<span class="lc-msg__cursor"></span>' +
        '</div>';
      messages.appendChild(botDiv);
      scrollChat();

      var contentEl  = botDiv.querySelector('.lc-msg__content');
      var thinkingEl = botDiv.querySelector('.lc-msg__thinking');
      var cursorEl   = botDiv.querySelector('.lc-msg__cursor');

      isStreaming = true;
      sendBtn.disabled = true;
      abortCtrl = new AbortController();

      var firstTokenReceived = false;

      // Reload settings in case they changed
      typingSettings = loadTypingSettings();

      // Create typewriter instance for this message
      var tw = typingSettings.enabled
        ? createTypewriter(contentEl, cursorEl, scrollChat)
        : null;
      activeTypewriter = tw;

      // Use fetch + ReadableStream for SSE
      fetch('/v1/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: text }),
        signal: abortCtrl.signal,
      }).then(function(response) {
        if (!response.ok) {
          throw new Error('HTTP ' + response.status);
        }

        var reader = response.body.getReader();
        var decoder = new TextDecoder();
        var buffer = '';
        var fullText = '';

        function processStream() {
          return reader.read().then(function(result) {
            if (result.done) {
              // Stream ended
              if (tw) {
                tw.finish();
              } else {
                cursorEl.style.display = 'none';
              }
              isStreaming = false;
              sendBtn.disabled = false;
              activeTypewriter = null;
              input.focus();
              return;
            }

            buffer += decoder.decode(result.value, { stream: true });
            var lines = buffer.split('\n');
            buffer = lines.pop();

            for (var i = 0; i < lines.length; i++) {
              var line = lines[i].trim();
              if (line.startsWith('data: ')) {
                var eventType = 'token';
                // Check preceding event line
                if (i > 0 && lines[i-1].trim().startsWith('event: ')) {
                  eventType = lines[i-1].trim().replace('event: ', '');
                }

                try {
                  var payload = JSON.parse(line.substring(6));

                  if (eventType === 'token' && payload.delta) {
                    if (!firstTokenReceived) {
                      firstTokenReceived = true;
                      thinkingEl.style.display = 'none';
                    }

                    if (tw) {
                      // Typewriter: push token to buffer
                      tw.push(payload.delta);
                    } else {
                      // Instant: render directly
                      fullText += payload.delta;
                      contentEl.innerHTML = formatMarkdown(fullText);
                      scrollChat();
                    }
                  }

                  if (eventType === 'done') {
                    if (tw) {
                      tw.finish();
                    } else {
                      cursorEl.style.display = 'none';
                    }
                  }

                  if (eventType === 'error') {
                    if (tw) tw.cancel();
                    thinkingEl.style.display = 'none';
                    cursorEl.style.display = 'none';
                    contentEl.innerHTML = '<span style="color:var(--red)">' +
                      escapeHtml(payload.message || 'AI error') + '</span>';
                  }
                } catch(e) {}
              } else if (line.startsWith('event: ')) {
                // Store event type â€” handled with next data line
              }
            }

            return processStream();
          });
        }

        return processStream();
      }).catch(function(err) {
        if (err.name === 'AbortError') return;
        if (tw) tw.cancel();
        thinkingEl.style.display = 'none';
        cursorEl.style.display = 'none';
        contentEl.innerHTML = '<span style="color:var(--red)">Could not reach the AI service. It may be loading.</span>';
        isStreaming = false;
        sendBtn.disabled = false;
        activeTypewriter = null;
      });
    }

    /* â”€â”€ Image Generation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function sendImage(prompt) {
      chatArea.style.display = 'none';
      imageResult.style.display = '';

      imageInner.innerHTML =
        '<div class="img-progress">' +
          '<div class="img-progress__spinner"></div>' +
          '<p class="img-progress__text">Generating imageâ€¦</p>' +
          '<p class="img-progress__hint">This may take 15-60 seconds</p>' +
        '</div>';

      isStreaming = true;
      sendBtn.disabled = true;

      fetch('/v1/image/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt: prompt }),
      })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (data.error) {
          imageInner.innerHTML =
            '<div class="img-error">' +
              '<p style="color:var(--red);font-weight:600;">Image generation: ' + escapeHtml(data.error) + '</p>' +
              (data.detail ? '<p style="color:var(--text-dim);font-size:.8rem;margin-top:8px;">' + escapeHtml(data.detail) + '</p>' : '') +
            '</div>';
        } else {
          var timeStr = data.timings ? (data.timings.generation_ms/1000).toFixed(1) + 's' : '';
          var stepsStr = data.timings ? data.timings.steps + ' steps' : '';
          imageInner.innerHTML =
            '<div class="img-result">' +
              '<img class="img-result__image" src="' + data.image_url + '" alt="Generated image">' +
              '<div class="img-result__meta">' +
                '<div class="img-result__seed">Seed: ' + data.seed + '</div>' +
                '<div class="img-result__time">' + timeStr + ' Â· ' + stepsStr + '</div>' +
                '<button class="btn btn--ghost btn--sm img-result__copy" data-prompt="' + escapeHtml(prompt) + '">Copy Prompt</button>' +
              '</div>' +
            '</div>';

          // Copy prompt handler
          var copyBtn = imageInner.querySelector('.img-result__copy');
          if (copyBtn) {
            copyBtn.addEventListener('click', function() {
              navigator.clipboard.writeText(this.dataset.prompt).then(function() {
                copyBtn.textContent = 'Copied!';
                setTimeout(function() { copyBtn.textContent = 'Copy Prompt'; }, 2000);
              });
            });
          }

          loadQuota(); // Refresh quota
        }
      })
      .catch(function() {
        imageInner.innerHTML =
          '<div class="img-error">' +
            '<p style="color:var(--red);font-weight:600;">Image service unavailable</p>' +
          '</div>';
      })
      .finally(function() {
        isStreaming = false;
        sendBtn.disabled = false;
        input.focus();
      });
    }

    /* â”€â”€ Typing Gear Popover â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    var gearBtn    = document.getElementById('typing-gear-btn');
    var gearMenu   = document.getElementById('typing-gear-menu');
    var gearWrap   = document.getElementById('typing-gear');
    var twEnabled  = document.getElementById('tw-enabled');
    var twMode     = document.getElementById('tw-mode');
    var twSpeed    = document.getElementById('tw-speed');
    var twSpeedVal = document.getElementById('tw-speed-val');
    var twAdaptive = document.getElementById('tw-adaptive');
    var twModeRow  = document.getElementById('tw-mode-row');
    var twSpeedRow = document.getElementById('tw-speed-row');
    var twAdaptiveRow = document.getElementById('tw-adaptive-row');

    // Populate UI from settings
    function syncTypingUI() {
      twEnabled.checked  = typingSettings.enabled;
      twMode.value       = typingSettings.mode;
      twSpeed.value      = typingSettings.speed;
      twSpeedVal.textContent = typingSettings.speed;
      twAdaptive.checked = typingSettings.adaptiveCatchUp;
      var show = typingSettings.enabled;
      twModeRow.style.display     = show ? '' : 'none';
      twSpeedRow.style.display    = show ? '' : 'none';
      twAdaptiveRow.style.display = show ? '' : 'none';
    }
    syncTypingUI();

    function openGear()  { gearWrap.classList.add('typing-gear--open'); gearBtn.setAttribute('aria-expanded','true'); }
    function closeGear() { gearWrap.classList.remove('typing-gear--open'); gearBtn.setAttribute('aria-expanded','false'); }

    gearBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      gearWrap.classList.contains('typing-gear--open') ? closeGear() : openGear();
    });
    document.addEventListener('click', function(e) {
      if (!gearWrap.contains(e.target)) closeGear();
    });

    function updateTypingSetting() {
      typingSettings.enabled         = twEnabled.checked;
      typingSettings.mode            = twMode.value;
      typingSettings.speed           = parseInt(twSpeed.value, 10);
      typingSettings.adaptiveCatchUp = twAdaptive.checked;
      twSpeedVal.textContent = twSpeed.value;
      var show = typingSettings.enabled;
      twModeRow.style.display     = show ? '' : 'none';
      twSpeedRow.style.display    = show ? '' : 'none';
      twAdaptiveRow.style.display = show ? '' : 'none';
      saveTypingSettings(typingSettings);
    }

    twEnabled.addEventListener('change', function() {
      updateTypingSetting();
      // If disabled mid-stream, flush active typewriter immediately
      if (!this.checked && activeTypewriter) {
        activeTypewriter.flush();
      }
    });
    twMode.addEventListener('change', updateTypingSetting);
    twSpeed.addEventListener('input', updateTypingSetting);
    twAdaptive.addEventListener('change', updateTypingSetting);

    /* â”€â”€ Check if user is logged in â†’ show avatar â”€â”€â”€â”€â”€â”€â”€â”€ */
    (function checkUserSession() {
      fetch('/api/me', { credentials: 'same-origin' })
        .then(function(r) {
          if (!r.ok) throw new Error('Not logged in');
          return r.json();
        })
        .then(function(user) {
          var navLogin    = document.getElementById('nav-login');
          var navRegister = document.getElementById('nav-register');
          var navAvatar   = document.getElementById('nav-avatar');
          var avatarImg   = document.getElementById('nav-avatar-img');

          if (navLogin)    navLogin.style.display = 'none';
          if (navRegister) navRegister.style.display = 'none';
          if (navAvatar) {
            navAvatar.style.display = '';
            if (user.avatar_url && avatarImg) {
              avatarImg.src = user.avatar_url;
              avatarImg.alt = user.name || user.email;
            } else if (avatarImg) {
              // Generate initials avatar
              var initials = (user.name || user.email || '?').charAt(0).toUpperCase();
              avatarImg.style.display = 'none';
              var initialsEl = document.createElement('div');
              initialsEl.style.cssText = 'width:32px;height:32px;border-radius:50%;background:var(--accent);color:#fff;display:flex;align-items:center;justify-content:center;font-size:.8rem;font-weight:700;border:2px solid var(--accent-hover);';
              initialsEl.textContent = initials;
              avatarImg.parentNode.appendChild(initialsEl);
            }
          }
        })
        .catch(function() {
          // Not logged in â€” keep Login / Get Started buttons
        });
    })();

    /* â”€â”€ Logo click: reset to landing (if chatting) â”€â”€â”€â”€â”€â”€ */
    document.getElementById('nav-logo').addEventListener('click', function(e) {
      if (heroChat && heroChat.classList.contains('is-chatting')) {
        e.preventDefault();
        heroChat.classList.remove('is-chatting');
        if (welcome) welcome.style.display = '';
        chatArea.style.display = 'none';
        imageResult.style.display = 'none';
        messages.innerHTML = '';
        input.focus();
      }
    });

  })();
  </script>
</body>
</html>
