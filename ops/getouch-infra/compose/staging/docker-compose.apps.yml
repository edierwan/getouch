# Staging App Services  (develop branch → dev.getouch.co → postgres-ssd)
# Shares the main Caddy + Cloudflare tunnel; no separate ingress needed.
#
# Usage:
#   cd /opt/getouch/compose/staging
#   docker compose -p getouch-stg -f docker-compose.apps.yml up -d --build

x-app-defaults: &app-defaults
  restart: unless-stopped
  logging:
    driver: json-file
    options:
      max-size: "10m"
      max-file: "3"

services:
  landing:
    <<: *app-defaults
    container_name: landing-stg
    build:
      context: /opt/getouch-stg/services/landing
      dockerfile: Dockerfile
    environment:
      PORT: "3000"
      NODE_ENV: staging
      VERSION: "2.0.0-dev"
      PUBLIC_URL: "https://dev.getouch.co"
      TZ: Asia/Kuala_Lumpur
    networks:
      - getouch_app
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://127.0.0.1:3000/health',r=>{r.statusCode===200?process.exit(0):process.exit(1)}).on('error',()=>process.exit(1))"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  bot:
    <<: *app-defaults
    container_name: bot-stg
    build:
      context: /opt/getouch-stg/services/bot
      dockerfile: Dockerfile
    environment:
      PORT: "3000"
      NODE_ENV: staging
      OLLAMA_HOST: ${OLLAMA_HOST:-ollama}
      OLLAMA_PORT: ${OLLAMA_PORT:-11434}
      OLLAMA_MODEL: ${OLLAMA_MODEL:-qwen2.5:7b}
      DATABASE_URL: ${DATABASE_URL_BOT_STG:-postgresql://getouch:${POSTGRES_STG_PASSWORD}@postgres-ssd:5432/getouch_bot}
      TZ: Asia/Kuala_Lumpur
    networks:
      - getouch_app
      - getouch_data
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://127.0.0.1:3000/health',r=>{r.statusCode===200?process.exit(0):process.exit(1)}).on('error',()=>process.exit(1))"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

  wa:
    <<: *app-defaults
    container_name: wa-stg
    build:
      context: /opt/getouch-stg/services/wa
      dockerfile: Dockerfile
    environment:
      PORT: "3000"
      NODE_ENV: staging
      DATABASE_URL: ${DATABASE_URL_WA_STG:-postgresql://getouch:${POSTGRES_STG_PASSWORD}@postgres-ssd:5432/getouch_wa}
      TZ: Asia/Kuala_Lumpur
    volumes:
      - /opt/getouch-stg/data/wa-sessions:/app/sessions
    networks:
      - getouch_app
      - getouch_data
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3000/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

  api:
    <<: *app-defaults
    container_name: api-stg
    build:
      context: /opt/getouch-stg/services/api
      dockerfile: Dockerfile
    environment:
      PORT: "3000"
      NODE_ENV: staging
      OLLAMA_HOST: ${OLLAMA_HOST:-ollama}
      OLLAMA_PORT: ${OLLAMA_PORT:-11434}
      OLLAMA_MODEL: ${OLLAMA_MODEL:-qwen2.5:7b}
      DATABASE_URL: ${DATABASE_URL_STG:-postgresql://getouch:${POSTGRES_STG_PASSWORD}@postgres-ssd:5432/getouch}
      TZ: Asia/Kuala_Lumpur
    networks:
      - getouch_app
      - getouch_data
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3000/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

networks:
  getouch_app:
    external: true
  getouch_data:
    external: true
