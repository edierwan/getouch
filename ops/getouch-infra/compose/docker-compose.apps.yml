# Application services
# Usage: docker compose -f docker-compose.apps.yml up -d --build

x-app-defaults: &app-defaults
  restart: unless-stopped
  logging:
    driver: json-file
    options:
      max-size: "10m"
      max-file: "5"

services:
  landing:
    <<: *app-defaults
    build:
      context: /opt/getouch/services/landing
      dockerfile: Dockerfile
    container_name: landing
    environment:
      PORT: "3000"
      VERSION: "2.0.0"
      TZ: Asia/Kuala_Lumpur
      NODE_ENV: production
      DATABASE_URL: postgresql://${POSTGRES_USER:-getouch}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-getouch}
      DATABASE_URL_PROD: postgresql://${POSTGRES_USER:-getouch}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-getouch}
      DATABASE_URL_DEV: postgresql://${POSTGRES_USER:-getouch}:${POSTGRES_PASSWORD}@postgres-ssd:5432/${POSTGRES_DB:-getouch}
      SESSION_SECRET: ${SESSION_SECRET:-getouch-session-secret}
      OLLAMA_HOST: ollama
      OLLAMA_PORT: "11434"
      COMFYUI_HOST: comfyui
      COMFYUI_PORT: "8188"
      ADMIN_TOKEN: ${ADMIN_TOKEN:-}
      SMTP_HOST: ${SMTP_HOST:-smtp.gmail.com}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASS: ${SMTP_PASS:-}
      SMTP_FROM: ${SMTP_FROM:-noreply@getouch.co}
      VERIFY_SECRET: ${VERIFY_SECRET:-getouch-verify-default}
      PUBLIC_URL: ${PUBLIC_URL:-https://getouch.co}
      CLOUDFLARE_API_TOKEN: ${CLOUDFLARE_API_TOKEN:-}
      CLOUDFLARE_ZONE_ID: ${CLOUDFLARE_ZONE_ID:-}
      CLOUDFLARE_ACCOUNT_ID: ${CLOUDFLARE_ACCOUNT_ID:-}
      EMAIL_DOMAIN: ${EMAIL_DOMAIN:-getouch.co}
    volumes:
      - /opt/getouch/data/images:/app/data/images
    networks:
      - getouch_app
      - getouch_data
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://127.0.0.1:3000/health',r=>{r.statusCode===200?process.exit(0):process.exit(1)}).on('error',()=>process.exit(1))"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  bot:
    <<: *app-defaults
    build:
      context: /opt/getouch/services/bot
      dockerfile: Dockerfile
    container_name: bot
    environment:
      PORT: "3000"
      VERSION: "2.0.0"
      OLLAMA_HOST: ollama
      OLLAMA_PORT: "11434"
      OLLAMA_MODEL: "llama3.1:8b"
      DATABASE_URL: ${DATABASE_URL_BOT:-postgresql://getouch:getouch@postgres:5432/getouch_bot}
      TZ: Asia/Kuala_Lumpur
      NODE_ENV: production
    networks:
      - getouch_app
      - getouch_data
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://127.0.0.1:3000/health',r=>{r.statusCode===200?process.exit(0):process.exit(1)}).on('error',()=>process.exit(1))"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

  wa:
    <<: *app-defaults
    build:
      context: /opt/getouch/services/wa
      dockerfile: Dockerfile
    container_name: wa
    environment:
      PORT: "3000"
      VERSION: "1.0.0"
      DATABASE_URL: ${DATABASE_URL_WA:-postgresql://getouch:getouch@postgres:5432/getouch_wa}
      TZ: Asia/Kuala_Lumpur
      NODE_ENV: production
    volumes:
      - /opt/getouch/data/wa-sessions:/app/sessions
    networks:
      - getouch_app
      - getouch_data
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3000/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

  api:
    <<: *app-defaults
    build:
      context: /opt/getouch/services/api
      dockerfile: Dockerfile
    container_name: api
    environment:
      PORT: "3000"
      VERSION: "1.0.0"
      OLLAMA_HOST: ollama
      OLLAMA_PORT: "11434"
      DATABASE_URL: ${DATABASE_URL:-postgresql://getouch:getouch@postgres:5432/getouch_api}
      TZ: Asia/Kuala_Lumpur
      NODE_ENV: production
    networks:
      - getouch_app
      - getouch_data
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3000/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

networks:
  getouch_app:
    external: true
  getouch_data:
    external: true
